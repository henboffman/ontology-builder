@using Eidos.Models
@using Eidos.Components.Shared

<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div class="flex-grow-1">
                <button class="btn btn-sm btn-outline-secondary mb-2" @onclick="OnBackClick">
                    <i class="bi bi-arrow-left"></i> Back to Dashboard
                </button>
                <h2>@Ontology.Name</h2>
                @if (!string.IsNullOrWhiteSpace(Ontology.Description))
                {
                    <p class="text-muted">@Ontology.Description</p>
                }
                @if (!string.IsNullOrWhiteSpace(Ontology.Tags))
                {
                    <div class="mb-2">
                        @foreach (var tag in Ontology.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries))
                        {
                            <span class="badge bg-info me-1">@tag</span>
                        }
                    </div>
                }
                <div class="d-flex gap-3 text-muted small flex-wrap">
                    <span><i class="bi bi-circle-fill"></i> @Ontology.Concepts.Count concepts</span>
                    <span><i class="bi bi-arrow-left-right"></i> @Ontology.Relationships.Count relationships</span>
                    @if (!string.IsNullOrWhiteSpace(Ontology.Author))
                    {
                        <span><i class="bi bi-person"></i> @Ontology.Author</span>
                    }
                    @if (!string.IsNullOrWhiteSpace(Ontology.Version))
                    {
                        <span><i class="bi bi-tag"></i> v@Ontology.Version</span>
                    }
                    @if (Ontology.ParentOntologyId != null)
                    {
                        <span class="badge bg-secondary">
                            <i class="bi bi-diagram-3"></i> @Ontology.ProvenanceType
                        </span>
                    }
                </div>
            </div>

            <!-- Desktop: Full button layout (visible on md and up) -->
            <div class="d-none d-md-flex gap-2 align-items-start flex-shrink-0">
                <button class="btn btn-sm btn-outline-secondary"
                        @onclick="ShowLineage"
                        title="View ontology lineage and provenance">
                    <i class="bi bi-diagram-3"></i> Lineage
                </button>

                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-primary"
                            @onclick="ShowForkDialog"
                            title="Fork this ontology to create a divergent copy">
                        <i class="bi bi-diagram-2"></i> Fork
                    </button>
                    <button class="btn btn-outline-primary"
                            @onclick="ShowCloneDialog"
                            title="Clone this ontology to create an exact copy">
                        <i class="bi bi-files"></i> Clone
                    </button>
                </div>

                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-info"
                            @onclick="OpenShareModal"
                            disabled="@(!CanShare)"
                            title="Share this ontology with others">
                        <i class="bi bi-share"></i> Share
                    </button>
                    <button class="btn btn-outline-secondary"
                            @onclick="OnSettingsClick"
                            disabled="@(!CanShare)"
                            title="Edit ontology settings and metadata">
                        <i class="bi bi-gear"></i> Settings
                    </button>
                </div>

                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-success"
                            @onclick="OnImportClick"
                            disabled="@(!CanEdit)"
                            title="Import concepts from TTL file">
                        <i class="bi bi-upload"></i> Import
                    </button>
                    <button class="btn btn-outline-success"
                            @onclick="OnExportClick"
                            title="Export ontology to various formats">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>
            </div>

            <!-- Mobile: Actions dropdown (visible on sm and below) -->
            <div class="dropdown d-md-none">
                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" id="actionsDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots-vertical"></i> Actions
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="actionsDropdown">
                    <li>
                        <button class="dropdown-item" @onclick="ShowLineage">
                            <i class="bi bi-diagram-3 me-2"></i> View Lineage
                        </button>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <button class="dropdown-item" @onclick="ShowForkDialog">
                            <i class="bi bi-diagram-2 me-2"></i> Fork Ontology
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" @onclick="ShowCloneDialog">
                            <i class="bi bi-files me-2"></i> Clone Ontology
                        </button>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <button class="dropdown-item" @onclick="OpenShareModal" disabled="@(!CanShare)">
                            <i class="bi bi-share me-2"></i> Share
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" @onclick="OnSettingsClick" disabled="@(!CanShare)">
                            <i class="bi bi-gear me-2"></i> Settings
                        </button>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <button class="dropdown-item" @onclick="OnImportClick" disabled="@(!CanEdit)">
                            <i class="bi bi-upload me-2"></i> Import
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" @onclick="OnExportClick">
                            <i class="bi bi-download me-2"></i> Export
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Share Modal -->
<ShareModal Show="@showShareModal"
            ShowChanged="@((bool show) => showShareModal = show)"
            OntologyId="@Ontology.Id"
            OntologyName="@Ontology.Name"
            UserId="@Ontology.UserId" />

<!-- Lineage Modal -->
<OntologyLineage @ref="lineageComponent" ontology="@Ontology" />

<!-- Fork/Clone Dialog -->
<ForkCloneDialog @ref="forkCloneDialog" />

@code {
    [Parameter, EditorRequired]
    public Ontology Ontology { get; set; } = null!;

    [Parameter]
    public EventCallback OnBackClick { get; set; }

    [Parameter]
    public EventCallback OnSettingsClick { get; set; }

    [Parameter]
    public EventCallback OnImportClick { get; set; }

    [Parameter]
    public EventCallback OnExportClick { get; set; }

    [Parameter]
    public bool CanShare { get; set; } = true;

    [Parameter]
    public bool CanEdit { get; set; } = true;

    private bool showShareModal = false;
    private OntologyLineage? lineageComponent;
    private ForkCloneDialog? forkCloneDialog;

    private void OpenShareModal()
    {
        showShareModal = true;
    }

    private async Task ShowLineage()
    {
        if (lineageComponent != null)
        {
            await lineageComponent.Show(Ontology);
        }
    }

    private void ShowForkDialog()
    {
        forkCloneDialog?.ShowFork(Ontology);
    }

    private void ShowCloneDialog()
    {
        forkCloneDialog?.ShowClone(Ontology);
    }
}
