@using Eidos.Models
@using Eidos.Models.Enums
@using Eidos.Services
@using Eidos.Services.Interfaces
@inject ILogger<IndividualManagementPanel> Logger
@inject IIndividualService IndividualService
@inject ToastService ToastService
@inject ConfirmService ConfirmService

@code {
    // Parameters
    [Parameter, EditorRequired] public int OntologyId { get; set; }
    [Parameter, EditorRequired] public ICollection<Concept> Concepts { get; set; } = new List<Concept>();
    [Parameter] public PermissionLevel? UserPermissionLevel { get; set; }

    // EventCallbacks for parent communication
    [Parameter] public EventCallback<Individual> OnIndividualCreated { get; set; }
    [Parameter] public EventCallback<Individual> OnIndividualUpdated { get; set; }
    [Parameter] public EventCallback<int> OnIndividualDeleted { get; set; }

    // Internal state
    private bool showAddIndividual = false;
    private Individual? editingIndividual = null;
    private Individual newIndividual = new();
    private List<IndividualProperty> newIndividualProperties = new();

    // Public properties for binding
    public int ConceptId => newIndividual.ConceptId;
    public string IndividualName => newIndividual.Name ?? string.Empty;
    public string? IndividualDescription => newIndividual.Description;
    public string? IndividualLabel => newIndividual.Label;
    public string? IndividualUri => newIndividual.Uri;
    public List<IndividualProperty> Properties => newIndividualProperties;
    public bool IsEditing => editingIndividual != null;

    // Public event handlers for binding
    public EventCallback<int> OnConceptIdChanged => EventCallback.Factory.Create<int>(this, value =>
    {
        newIndividual.ConceptId = value;
        StateHasChanged();
    });

    public EventCallback<string> OnIndividualNameChanged => EventCallback.Factory.Create<string>(this, value =>
    {
        newIndividual.Name = value;
        StateHasChanged();
    });

    public EventCallback<string?> OnIndividualDescriptionChanged => EventCallback.Factory.Create<string?>(this, value =>
    {
        newIndividual.Description = value;
        StateHasChanged();
    });

    public EventCallback<string?> OnIndividualLabelChanged => EventCallback.Factory.Create<string?>(this, value =>
    {
        newIndividual.Label = value;
        StateHasChanged();
    });

    public EventCallback<string?> OnIndividualUriChanged => EventCallback.Factory.Create<string?>(this, value =>
    {
        newIndividual.Uri = value;
        StateHasChanged();
    });

    public EventCallback<List<IndividualProperty>> OnPropertiesChanged => EventCallback.Factory.Create<List<IndividualProperty>>(this, value =>
    {
        newIndividualProperties = value;
        StateHasChanged();
    });

    public EventCallback OnSaveClick => EventCallback.Factory.Create(this, SaveIndividual);
    public EventCallback OnCancelClick => EventCallback.Factory.Create(this, CancelEditIndividual);

    /// <summary>
    /// Shows the add individual dialog with a new blank individual.
    /// </summary>
    public Task ShowAddIndividualDialog()
    {
        newIndividual = new Individual
        {
            OntologyId = OntologyId
        };
        newIndividualProperties = new List<IndividualProperty>();
        editingIndividual = null;
        showAddIndividual = true;
        StateHasChanged();

        return Task.CompletedTask;
    }

    /// <summary>
    /// Shows the edit individual dialog for an existing individual.
    /// </summary>
    /// <param name="individual">The individual to edit.</param>
    public void ShowEditIndividualDialog(Individual individual)
    {
        editingIndividual = individual;
        newIndividual = new Individual
        {
            Id = individual.Id,
            OntologyId = individual.OntologyId,
            ConceptId = individual.ConceptId,
            Name = individual.Name,
            Description = individual.Description,
            Label = individual.Label,
            Uri = individual.Uri
        };

        // Clone properties
        newIndividualProperties = individual.Properties
            .Select(p => new IndividualProperty
            {
                Id = p.Id,
                IndividualId = p.IndividualId,
                Name = p.Name,
                Value = p.Value,
                DataType = p.DataType
            })
            .ToList();

        showAddIndividual = true;
        StateHasChanged();
    }

    /// <summary>
    /// Shows the duplicate individual dialog with a copy of the individual.
    /// </summary>
    /// <param name="individual">The individual to duplicate.</param>
    public Task ShowDuplicateIndividualDialog(Individual individual)
    {
        newIndividual = new Individual
        {
            OntologyId = OntologyId,
            ConceptId = individual.ConceptId,
            Name = $"{individual.Name} (Copy)",
            Description = individual.Description,
            Label = individual.Label,
            Uri = individual.Uri
        };

        // Clone properties
        newIndividualProperties = individual.Properties
            .Select(p => new IndividualProperty
            {
                Name = p.Name,
                Value = p.Value,
                DataType = p.DataType
            })
            .ToList();

        editingIndividual = null;
        showAddIndividual = true;
        StateHasChanged();

        ToastService.ShowInfo("Ready to create copy of individual. Click 'Add' to save or 'Cancel' to discard.", 5000);
        return Task.CompletedTask;
    }

    /// <summary>
    /// Hides the individual dialog.
    /// </summary>
    public void HideDialog()
    {
        showAddIndividual = false;
        editingIndividual = null;
        newIndividual = new Individual();
        newIndividualProperties = new List<IndividualProperty>();
        StateHasChanged();
    }

    /// <summary>
    /// Checks if the dialog is currently visible.
    /// </summary>
    public bool IsDialogVisible()
    {
        return showAddIndividual || editingIndividual != null;
    }

    private async Task SaveIndividual()
    {
        if (string.IsNullOrWhiteSpace(newIndividual.Name) || newIndividual.ConceptId == 0)
            return;

        // Check permissions
        if (editingIndividual != null && !CanEdit())
        {
            ToastService.ShowError("You do not have permission to edit individuals");
            return;
        }
        else if (editingIndividual == null && !CanAdd())
        {
            ToastService.ShowError("You do not have permission to add individuals");
            return;
        }

        try
        {
            newIndividual.Properties = newIndividualProperties;

            if (editingIndividual != null)
            {
                // Update existing individual
                await IndividualService.UpdateAsync(newIndividual);
                ToastService.ShowSuccess($"Updated individual \"{newIndividual.Name}\"");
                await OnIndividualUpdated.InvokeAsync(newIndividual);
                editingIndividual = null;
            }
            else
            {
                // Create new individual
                var createdIndividual = await IndividualService.CreateAsync(newIndividual);
                ToastService.ShowSuccess($"Created individual \"{newIndividual.Name}\"");
                await OnIndividualCreated.InvokeAsync(createdIndividual);
            }

            showAddIndividual = false;
            newIndividual = new Individual();
            newIndividualProperties = new List<IndividualProperty>();
        }
        catch (Exception ex)
        {
            var errorMessage = ex.InnerException != null
                ? $"{ex.Message} - {ex.InnerException.Message}"
                : ex.Message;
            ToastService.ShowError($"Failed to save individual: {errorMessage}", 8000);
        }
    }

    private void CancelEditIndividual()
    {
        showAddIndividual = false;
        editingIndividual = null;
        newIndividual = new Individual();
        newIndividualProperties = new List<IndividualProperty>();
    }

    /// <summary>
    /// Deletes an individual after confirmation.
    /// </summary>
    /// <param name="individual">The individual to delete.</param>
    public async Task DeleteIndividualAsync(Individual individual)
    {
        var confirmed = await ConfirmService.ShowAsync(
            "Delete Individual",
            $"Are you sure you want to delete the individual \"{individual.Name}\"?",
            "Delete",
            ConfirmType.Danger
        );

        if (confirmed)
        {
            try
            {
                await IndividualService.DeleteAsync(individual.Id);
                ToastService.ShowSuccess($"Individual \"{individual.Name}\" deleted successfully.");
                await OnIndividualDeleted.InvokeAsync(individual.Id);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting individual {IndividualId}", individual.Id);
                ToastService.ShowError($"Failed to delete individual: {ex.Message}");
            }
        }
    }

    private bool CanAdd() => UserPermissionLevel.HasValue && UserPermissionLevel.Value >= PermissionLevel.ViewAndAdd;
    private bool CanEdit() => UserPermissionLevel.HasValue && UserPermissionLevel.Value >= PermissionLevel.ViewAddEdit;
}
