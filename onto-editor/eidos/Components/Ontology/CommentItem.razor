@using Eidos.Models.DTOs
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="comment-item @(Comment.IsResolved ? "comment-resolved" : "")" data-comment-id="@Comment.Id">
    <div class="comment-content">
        <div class="comment-meta d-flex justify-content-between align-items-start flex-wrap">
            <div class="mb-1">
                <strong class="comment-author">@Comment.UserName</strong>
                <span class="text-muted mx-1">Â·</span>
                <span class="text-muted">
                    <small>@FormatTimestamp(Comment.CreatedAt)</small>
                </span>
                @if (Comment.EditedAt.HasValue)
                {
                    <span class="text-muted ms-1">
                        <small>(edited)</small>
                    </span>
                }
                @if (Comment.IsResolved)
                {
                    <span class="badge bg-success ms-2">Resolved</span>
                }
            </div>
            <div class="comment-actions">
                @if (Comment.CanEdit)
                {
                    <button class="btn btn-sm btn-link text-muted p-0 me-1"
                            @onclick="() => ToggleEdit()"
                            title="Edit">
                        <i class="bi bi-pencil"></i>
                    </button>
                }
                @if (Comment.CanDelete)
                {
                    <button class="btn btn-sm btn-link text-danger p-0 me-1"
                            @onclick="() => OnDelete.InvokeAsync(Comment.Id)"
                            title="Delete">
                        <i class="bi bi-trash"></i>
                    </button>
                }
                @if (!Comment.IsResolved && Comment.ParentCommentId == null)
                {
                    <button class="btn btn-sm btn-link text-success p-0"
                            @onclick="() => OnResolve.InvokeAsync((Comment.Id, true))"
                            title="Resolve">
                        <i class="bi bi-check-circle"></i>
                    </button>
                }
                @if (Comment.IsResolved && Comment.ParentCommentId == null)
                {
                    <button class="btn btn-sm btn-link text-muted p-0"
                            @onclick="() => OnResolve.InvokeAsync((Comment.Id, false))"
                            title="Reopen">
                        <i class="bi bi-arrow-counterclockwise"></i>
                    </button>
                }
            </div>
        </div>

            @if (IsEditing)
            {
                <div class="comment-edit-form mt-2">
                    <textarea class="form-control form-control-sm"
                              @bind="EditedText"
                              rows="3"
                              placeholder="Edit your comment..."></textarea>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-primary me-2" @onclick="SaveEdit">
                            <i class="bi bi-check"></i> Save
                        </button>
                        <button class="btn btn-sm btn-secondary" @onclick="CancelEdit">
                            <i class="bi bi-x"></i> Cancel
                        </button>
                    </div>
                </div>
            }
            else
            {
                <div class="comment-text mt-1">
                    @((MarkupString)FormatCommentText(Comment.Text))
                </div>

                <div class="comment-footer mt-2">
                    <button class="btn btn-link btn-sm p-0 text-muted"
                            @onclick="() => OnReply.InvokeAsync(Comment.Id)">
                        <i class="bi bi-reply"></i> Reply
                    </button>
                    @if (Comment.Replies.Count > 0)
                    {
                        <button class="btn btn-link btn-sm p-0 text-muted ms-3"
                                @onclick="ToggleReplies">
                            <i class="bi bi-chevron-@(ShowReplies ? "up" : "down")"></i>
                            @Comment.Replies.Count @(Comment.Replies.Count == 1 ? "reply" : "replies")
                        </button>
                    }
                </div>
            }

            @if (ShowReplies && Comment.Replies.Count > 0)
            {
                <div class="comment-replies mt-3">
                    @foreach (var reply in Comment.Replies)
                    {
                        <CommentItem Comment="reply"
                                   OnReply="OnReply"
                                   OnEdit="OnEdit"
                                   OnDelete="OnDelete"
                                   OnResolve="OnResolve" />
                    }
                </div>
            }
    </div>
</div>

@code {
    [Parameter, EditorRequired]
    public CommentResponse Comment { get; set; } = null!;

    [Parameter]
    public EventCallback<int> OnReply { get; set; }

    [Parameter]
    public EventCallback<CommentResponse> OnEdit { get; set; }

    [Parameter]
    public EventCallback<int> OnDelete { get; set; }

    [Parameter]
    public EventCallback<(int CommentId, bool Resolve)> OnResolve { get; set; }

    private bool IsEditing { get; set; } = false;
    private bool ShowReplies { get; set; } = true;
    private string EditedText { get; set; } = string.Empty;

    private string GetUserInitials(string userName)
    {
        if (string.IsNullOrWhiteSpace(userName))
            return "?";

        var parts = userName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2)
        {
            return $"{parts[0][0]}{parts[1][0]}".ToUpper();
        }
        else if (parts.Length == 1 && parts[0].Length > 0)
        {
            return parts[0].Substring(0, Math.Min(2, parts[0].Length)).ToUpper();
        }

        return "?";
    }

    private string FormatTimestamp(DateTime timestamp)
    {
        var now = DateTime.UtcNow;
        var diff = now - timestamp;

        if (diff.TotalMinutes < 1)
            return "just now";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}d ago";
        if (diff.TotalDays < 30)
            return $"{(int)(diff.TotalDays / 7)}w ago";

        return timestamp.ToString("MMM d, yyyy");
    }

    private string FormatCommentText(string text)
    {
        if (string.IsNullOrWhiteSpace(text))
            return string.Empty;

        // Simple formatting: preserve line breaks and highlight @mentions
        var formatted = System.Web.HttpUtility.HtmlEncode(text);
        formatted = formatted.Replace("\n", "<br/>");

        // Highlight @mentions
        formatted = System.Text.RegularExpressions.Regex.Replace(
            formatted,
            @"@([\w.-]+@[\w.-]+|[\w.]+)",
            "<span class=\"comment-mention\">@$1</span>"
        );

        return formatted;
    }

    private void ToggleEdit()
    {
        IsEditing = !IsEditing;
        if (IsEditing)
        {
            EditedText = Comment.Text;
        }
    }

    private async Task SaveEdit()
    {
        // This will be handled via API call
        Comment.Text = EditedText;
        Comment.EditedAt = DateTime.UtcNow;
        IsEditing = false;
        await OnEdit.InvokeAsync(Comment);
    }

    private void CancelEdit()
    {
        IsEditing = false;
        EditedText = string.Empty;
    }

    private void ToggleReplies()
    {
        ShowReplies = !ShowReplies;
    }
}
