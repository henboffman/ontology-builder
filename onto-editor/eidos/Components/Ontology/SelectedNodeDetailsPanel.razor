@using Eidos.Models
@using Eidos.Services
@inject NavigationManager Navigation
@inject Data.Repositories.NoteRepository NoteRepository
@inject ToastService ToastService

<div class="card border-0 shadow-sm">
    <div class="card-header bg-light">
        <h6 class="mb-0 d-flex align-items-center">
            <i class="bi bi-info-circle me-2"></i>
            Details
        </h6>
    </div>
    <div class="card-body" style="max-height: calc(100vh - 200px); overflow-y: auto;">
        @if (SelectedConcept != null)
        {
            <div class="d-flex align-items-center gap-2 mb-2">
                <div style="width: 24px; height: 24px; background-color: @SelectedConcept.Color; border-radius: 4px;"></div>
                <h6 class="mb-0 flex-grow-1">@SelectedConcept.Name</h6>
            </div>

            @* View Note Button - Prominent placement at top *@
            <div class="mb-3">
                <button class="btn btn-sm btn-primary w-100" @onclick="ViewConceptNote"
                    title="Open this concept's note in the workspace">
                    <i class="bi bi-journal-text me-1"></i>
                    Open Note
                </button>
            </div>

            @if (!string.IsNullOrWhiteSpace(SelectedConcept.Category))
            {
                <p class="mb-2 small"><strong>Category:</strong> @SelectedConcept.Category</p>
            }

            @if (!string.IsNullOrWhiteSpace(SelectedConcept.SimpleExplanation))
            {
                <p class="mb-2 small"><strong>Explanation:</strong> @SelectedConcept.SimpleExplanation</p>
            }

            @if (!string.IsNullOrWhiteSpace(SelectedConcept.Definition))
            {
                <p class="mb-2 small"><strong>Definition:</strong> @SelectedConcept.Definition</p>
            }

            @if (!string.IsNullOrWhiteSpace(SelectedConcept.Examples))
            {
                <p class="mb-2 small">
                    <strong>Examples:</strong><br />
                    <em>@SelectedConcept.Examples</em>
                </p>
            }

            @if (ConnectedConcepts != null && ConnectedConcepts.Any())
            {
                <hr class="my-2" />
                <div class="mb-2">
                    <h6 class="small fw-bold mb-2">
                        <i class="bi bi-diagram-3 me-1"></i>
                        Connected (@ConnectedConcepts.Count())
                    </h6>
                    <div class="list-group list-group-flush">
                        @foreach (var connection in ConnectedConcepts.Take(5))
                        {
                            <div class="list-group-item px-0 py-1 border-0">
                                <div class="d-flex align-items-center gap-2">
                                    <div
                                        style="width: 16px; height: 16px; background-color: @connection.ConceptColor; border-radius: 3px; flex-shrink: 0;">
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="small">@connection.ConceptName</div>
                                        <small class="text-muted" style="font-size: 0.7rem;">
                                            @if (connection.IsOutgoing)
                                            {
                                                <span><i class="bi bi-arrow-right mx-1"></i> @connection.RelationType</span>
                                            }
                                            else
                                            {
                                                <span><i class="bi bi-arrow-left mx-1"></i> @connection.RelationType</span>
                                            }
                                        </small>
                                    </div>
                                </div>
                            </div>
                        }
                        @if (ConnectedConcepts.Count() > 5)
                        {
                            <div class="text-muted small">...and @(ConnectedConcepts.Count() - 5) more</div>
                        }
                    </div>
                </div>
            }

            @* Property Definitions Section *@
            @if (ConceptProperties != null)
            {
                <hr class="my-2" />
                <div class="mb-2">
                    <ConceptPropertyEditor ConceptId="@SelectedConcept.Id" Properties="@ConceptProperties"
                        PropertiesChanged="@OnPropertiesChanged" />
                </div>
            }

            @* Comments Section *@
            @if (OntologyId.HasValue)
            {
                <hr class="my-2" />
                <div class="mb-2">
                    <h6 class="small fw-bold mb-2">
                        <i class="bi bi-chat-left-text me-1"></i>
                        Discussion
                    </h6>
                    <CommentThread OntologyId="@OntologyId.Value" EntityType="Concept" EntityId="@SelectedConcept.Id" />
                </div>
            }
        }
        else if (SelectedRelationship != null)
        {
            <div class="mb-3">
                <h6 class="mb-2">
                    <i class="bi bi-arrow-left-right me-2"></i>
                    Relationship
                </h6>
            </div>

            <p class="mb-2 small"><strong>Type:</strong> @SelectedRelationship.RelationType</p>

            @if (SelectedRelationship.SourceConcept != null && SelectedRelationship.TargetConcept != null)
            {
                <div class="mb-2">
                    <div class="d-flex align-items-center gap-2 mb-1">
                        <div
                            style="width: 16px; height: 16px; background-color: @SelectedRelationship.SourceConcept.Color; border-radius: 3px;">
                        </div>
                        <span class="small">@SelectedRelationship.SourceConcept.Name</span>
                    </div>
                    <div class="text-center">
                        <i class="bi bi-arrow-down"></i>
                    </div>
                    <div class="d-flex align-items-center gap-2 mt-1">
                        <div
                            style="width: 16px; height: 16px; background-color: @SelectedRelationship.TargetConcept.Color; border-radius: 3px;">
                        </div>
                        <span class="small">@SelectedRelationship.TargetConcept.Name</span>
                    </div>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(SelectedRelationship.Description))
            {
                <p class="mb-2 small"><strong>Description:</strong> @SelectedRelationship.Description</p>
            }

            @* Comments Section *@
            @if (OntologyId.HasValue)
            {
                <hr class="my-2" />
                <div class="mb-2">
                    <h6 class="small fw-bold mb-2">
                        <i class="bi bi-chat-left-text me-1"></i>
                        Discussion
                    </h6>
                    <CommentThread OntologyId="@OntologyId.Value" EntityType="Relationship"
                        EntityId="@SelectedRelationship.Id" />
                </div>
            }
        }
        else if (SelectedIndividual != null)
        {
            <div class="mb-3">
                <h6 class="mb-2">
                    <i class="bi bi-person me-2"></i>
                    Individual
                </h6>
            </div>

            <p class="mb-2 small"><strong>Name:</strong> @SelectedIndividual.Name</p>

            @if (SelectedIndividual.Concept != null)
            {
                <div class="d-flex align-items-center gap-2 mb-2">
                    <span class="small"><strong>Type:</strong></span>
                    <div
                        style="width: 16px; height: 16px; background-color: @SelectedIndividual.Concept.Color; border-radius: 3px;">
                    </div>
                    <span class="small">@SelectedIndividual.Concept.Name</span>
                </div>
            }

            @if (!string.IsNullOrWhiteSpace(SelectedIndividual.Description))
            {
                <p class="mb-2 small"><strong>Description:</strong> @SelectedIndividual.Description</p>
            }

            @* Comments Section *@
            @if (OntologyId.HasValue)
            {
                <hr class="my-2" />
                <div class="mb-2">
                    <h6 class="small fw-bold mb-2">
                        <i class="bi bi-chat-left-text me-1"></i>
                        Discussion
                    </h6>
                    <CommentThread OntologyId="@OntologyId.Value" EntityType="Individual" EntityId="@SelectedIndividual.Id" />
                </div>
            }
        }
        else
        {
            <div class="text-center text-muted py-4">
                <i class="bi bi-cursor-fill mb-2" style="font-size: 2rem; opacity: 0.3;"></i>
                <p class="small mb-0">Select a concept, relationship, or individual to see details</p>
            </div>
        }
    </div>
</div>

@code
{
    [Parameter] public Concept? SelectedConcept { get; set; }
    [Parameter] public Relationship? SelectedRelationship { get; set; }
    [Parameter] public Individual? SelectedIndividual { get; set; }
    [Parameter] public IEnumerable<ConceptConnection>? ConnectedConcepts { get; set; }
    [Parameter] public ICollection<ConceptProperty>? ConceptProperties { get; set; }
    [Parameter] public EventCallback OnPropertiesChanged { get; set; }
    [Parameter] public int? OntologyId { get; set; }

    protected override void OnParametersSet()
    {
        Console.WriteLine($"[SelectedNodeDetailsPanel] OnParametersSet - Concept: {SelectedConcept?.Name ?? "null"}, Relationship: {SelectedRelationship?.RelationType ?? "null"}, Individual: {SelectedIndividual?.Name ?? "null"}");
        base.OnParametersSet();
    }

    private async Task ViewConceptNote()
    {
        if (SelectedConcept == null || !OntologyId.HasValue)
        {
            ToastService.ShowWarning("Please select a concept first");
            return;
        }

        try
        {
            // Find the concept note for this concept
            var note = await NoteRepository.GetConceptNoteAsync(SelectedConcept.Id);

            if (note != null)
            {
                // Navigate to workspace with the note pre-selected
                Navigation.NavigateTo($"workspace/{note.WorkspaceId}?noteId={note.Id}");
            }
            else
            {
                // Note doesn't exist yet - just show a message
                ToastService.ShowInfo($"Note for '{SelectedConcept.Name}' will be created automatically when needed");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error navigating to concept note: {ex.Message}");
            ToastService.ShowError($"Error navigating to note: {ex.Message}");
        }
    }

    /// <summary>
    /// Represents a connection between the current concept and another concept via a relationship
    /// </summary>
    public class ConceptConnection
    {
        public int ConceptId { get; set; }
        public string ConceptName { get; set; } = string.Empty;
        public string ConceptColor { get; set; } = "#4A90E2";
        public string RelationType { get; set; } = string.Empty;
        public bool IsOutgoing { get; set; }
    }
}