@using Eidos.Models
@implements IDisposable

<div class="autosave-indicator @GetStatusClass()">
    @switch (Status)
    {
        case AutoSaveStatus.Idle:
            <span class="text-muted" style="font-size: 0.75rem;">
                <i class="bi bi-check-circle"></i> Saved @GetElapsedTime()
            </span>
            break;
        case AutoSaveStatus.Saving:
            <span class="text-primary" style="font-size: 0.75rem;">
                <span class="spinner-border spinner-border-sm me-1" style="width: 0.75rem; height: 0.75rem;"></span>
                Saving...
            </span>
            break;
        case AutoSaveStatus.Saved:
            <span class="text-success" style="font-size: 0.75rem;">
                <i class="bi bi-cloud-check-fill"></i> Saved @GetElapsedTime()
            </span>
            break;
        case AutoSaveStatus.Error:
            <span class="text-danger" style="font-size: 0.75rem;">
                <i class="bi bi-exclamation-triangle-fill"></i> Save failed
            </span>
            break;
    }
</div>

@code {
    [Parameter]
    public AutoSaveStatus Status { get; set; } = AutoSaveStatus.Idle;

    [Parameter]
    public DateTime? LastSavedTime { get; set; }

    private System.Threading.Timer? _timer;

    protected override void OnInitialized()
    {
        // Update the elapsed time display every 30 seconds
        _timer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(StateHasChanged);
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }

    private string GetElapsedTime()
    {
        if (LastSavedTime == null || Status == AutoSaveStatus.Saving)
            return string.Empty;

        var elapsed = DateTime.UtcNow - LastSavedTime.Value;

        if (elapsed.TotalMinutes < 1)
            return "just now";
        else if (elapsed.TotalMinutes < 60)
            return $"{(int)elapsed.TotalMinutes} minute{((int)elapsed.TotalMinutes == 1 ? "" : "s")} ago";
        else if (elapsed.TotalHours < 24)
            return $"{(int)elapsed.TotalHours} hour{((int)elapsed.TotalHours == 1 ? "" : "s")} ago";
        else
            return $"{(int)elapsed.TotalDays} day{((int)elapsed.TotalDays == 1 ? "" : "s")} ago";
    }

    private string GetStatusClass()
    {
        return Status switch
        {
            AutoSaveStatus.Saving => "saving",
            AutoSaveStatus.Saved => "saved",
            AutoSaveStatus.Error => "error",
            _ => "idle"
        };
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
