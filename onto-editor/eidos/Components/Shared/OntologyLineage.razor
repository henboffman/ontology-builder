@using Eidos.Models
@using Eidos.Services.Interfaces
@inject IOntologyService OntologyService
@inject NavigationManager Navigation

@if (isVisible && ontology != null)
{
    <div class="modal fade show" style="display: block;" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-diagram-3"></i> Ontology Lineage: @ontology.Name
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Hide" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    @if (isLoading)
                    {
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading lineage...</span>
                            </div>
                            <p class="text-muted mt-2">Loading ontology lineage...</p>
                        </div>
                    }
                    else
                    {
                        <!-- Ancestry Section -->
                        @if (lineage != null && lineage.Count > 1)
                        {
                            <div class="mb-4">
                                <h6 class="text-muted mb-3">
                                    <i class="bi bi-arrow-up-circle"></i> Ancestry
                                </h6>
                                <div class="lineage-tree">
                                    @for (int i = lineage.Count - 1; i >= 0; i--)
                                    {
                                        var item = lineage[i];
                                        var isCurrentOntology = item.Id == ontology.Id;
                                        var level = lineage.Count - 1 - i;

                                        <div class="lineage-item" style="margin-left: @(level * 30)px;">
                                            @if (i < lineage.Count - 1)
                                            {
                                                <div class="lineage-connector">
                                                    <i class="bi bi-arrow-return-right"></i>
                                                </div>
                                            }
                                            <div class="card mb-2 @(isCurrentOntology ? "border-primary" : "")">
                                                <div class="card-body py-2 px-3">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div>
                                                            <strong class="@(isCurrentOntology ? "text-primary" : "")">
                                                                @item.Name
                                                                @if (isCurrentOntology)
                                                                {
                                                                    <span class="badge bg-primary ms-2">Current</span>
                                                                }
                                                            </strong>
                                                            @if (!string.IsNullOrEmpty(item.ProvenanceType))
                                                            {
                                                                <span class="badge bg-secondary ms-2">@item.ProvenanceType</span>
                                                            }
                                                            @if (!string.IsNullOrEmpty(item.Description))
                                                            {
                                                                <div class="text-muted small">@item.Description</div>
                                                            }
                                                            @if (!string.IsNullOrEmpty(item.ProvenanceNotes))
                                                            {
                                                                <div class="text-muted small fst-italic">
                                                                    <i class="bi bi-info-circle"></i> @item.ProvenanceNotes
                                                                </div>
                                                            }
                                                        </div>
                                                        @if (!isCurrentOntology)
                                                        {
                                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => NavigateToOntology(item.Id)">
                                                                <i class="bi bi-eye"></i> View
                                                            </button>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info mb-4">
                                <i class="bi bi-info-circle"></i> This is an original ontology with no parent lineage.
                            </div>
                        }

                        <!-- Descendants Section -->
                        @if (descendants != null && descendants.Count > 0)
                        {
                            <div class="mb-4">
                                <h6 class="text-muted mb-3">
                                    <i class="bi bi-arrow-down-circle"></i> Descendants (@descendants.Count)
                                </h6>
                                <div class="descendants-list">
                                    @foreach (var descendant in descendants.OrderBy(d => d.CreatedAt))
                                    {
                                        <div class="card mb-2">
                                            <div class="card-body py-2 px-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <strong>@descendant.Name</strong>
                                                        @if (!string.IsNullOrEmpty(descendant.ProvenanceType))
                                                        {
                                                            <span class="badge bg-secondary ms-2">@descendant.ProvenanceType</span>
                                                        }
                                                        <div class="text-muted small">
                                                            Created @descendant.CreatedAt.ToString("MMM d, yyyy")
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(descendant.ProvenanceNotes))
                                                        {
                                                            <div class="text-muted small fst-italic">
                                                                <i class="bi bi-info-circle"></i> @descendant.ProvenanceNotes
                                                            </div>
                                                        }
                                                    </div>
                                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => NavigateToOntology(descendant.Id)">
                                                        <i class="bi bi-eye"></i> View
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i> No ontologies have been forked or cloned from this one yet.
                            </div>
                        }

                        <!-- Metadata -->
                        <div class="mt-4 pt-3 border-top">
                            <h6 class="text-muted mb-2">Provenance Metadata</h6>
                            <dl class="row mb-0 small">
                                <dt class="col-sm-4">Created:</dt>
                                <dd class="col-sm-8">@ontology.CreatedAt.ToString("MMM d, yyyy h:mm tt")</dd>

                                <dt class="col-sm-4">Last Updated:</dt>
                                <dd class="col-sm-8">@ontology.UpdatedAt.ToString("MMM d, yyyy h:mm tt")</dd>

                                @if (!string.IsNullOrEmpty(ontology.Author))
                                {
                                    <dt class="col-sm-4">Author:</dt>
                                    <dd class="col-sm-8">@ontology.Author</dd>
                                }

                                @if (!string.IsNullOrEmpty(ontology.Version))
                                {
                                    <dt class="col-sm-4">Version:</dt>
                                    <dd class="col-sm-8">@ontology.Version</dd>
                                }
                            </dl>
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Hide">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    [Parameter] public Ontology? ontology { get; set; }

    private bool isVisible = false;
    private bool isLoading = false;
    private List<Ontology>? lineage;
    private List<Ontology>? descendants;

    public async Task Show(Ontology ont)
    {
        ontology = ont;
        isVisible = true;
        isLoading = true;
        StateHasChanged();

        await LoadLineageData();

        isLoading = false;
        StateHasChanged();
    }

    public void Hide()
    {
        isVisible = false;
        StateHasChanged();
    }

    private async Task LoadLineageData()
    {
        if (ontology == null) return;

        try
        {
            // Load ancestry
            lineage = await OntologyService.GetOntologyLineageAsync(ontology.Id);

            // Load descendants
            descendants = await OntologyService.GetOntologyDescendantsAsync(ontology.Id);
        }
        catch (Exception ex)
        {
            // Log error but don't crash
            Console.WriteLine($"Error loading lineage: {ex.Message}");
            lineage = new List<Ontology>();
            descendants = new List<Ontology>();
        }
    }

    private void NavigateToOntology(int ontologyId)
    {
        Hide();
        Navigation.NavigateTo($"/ontology/{ontologyId}");
    }
}
