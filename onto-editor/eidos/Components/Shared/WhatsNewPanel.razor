@using Eidos.Models.DTOs
@using Eidos.Services.Interfaces

@* Always show the panel, but with different states *@
@if (!IsDismissed)
{
    <div class="whats-new-panel @(IsExpanded ? "expanded" : "collapsed") @(HasChanges ? "has-changes" : "no-changes")" @onclick="ToggleExpanded">
        <div class="whats-new-header">
            <div class="header-left">
                <i class="bi @(HasChanges ? "bi-stars" : "bi-clock-history")"></i>
                @if (HasChanges)
                {
                    <span class="header-title">What's New Since Your Last Visit</span>
                    <span class="change-count">@WhatsNew!.TotalChanges change@(WhatsNew.TotalChanges != 1 ? "s" : "")</span>
                }
                else
                {
                    <span class="header-title">Activity Timeline</span>
                }
            </div>
            <div class="header-right">
                <i class="bi @(IsExpanded ? "bi-chevron-up" : "bi-chevron-down")"></i>
            </div>
        </div>

        @if (IsExpanded)
        {
            <div class="whats-new-content" @onclick:stopPropagation="true">
                @if (WhatsNew != null)
                {
                    <div class="last-viewed">
                        <i class="bi bi-clock-history"></i>
                        Last viewed: <strong>@FormatTimestamp(WhatsNew.LastViewedAt)</strong>
                    </div>
                }
                else
                {
                    <div class="last-viewed">
                        <i class="bi bi-info-circle"></i>
                        This is your first visit to this ontology
                    </div>
                }

                @if (WhatsNew?.ContributorNames?.Any() == true)
                {
                    <div class="contributors">
                        <i class="bi bi-people"></i>
                        <span>Changes by: <strong>@string.Join(", ", WhatsNew.ContributorNames)</strong></span>
                    </div>
                }

                @if (HasChanges)
                {
                    <div class="change-summary">
                        <div class="summary-grid">
                            @if (WhatsNew!.ConceptsAdded > 0)
                            {
                                <div class="summary-item added">
                                    <i class="bi bi-plus-circle"></i>
                                    <span>@WhatsNew.ConceptsAdded concept@(WhatsNew.ConceptsAdded != 1 ? "s" : "") added</span>
                                </div>
                            }
                            @if (WhatsNew.ConceptsModified > 0)
                            {
                                <div class="summary-item modified">
                                    <i class="bi bi-pencil"></i>
                                    <span>@WhatsNew.ConceptsModified concept@(WhatsNew.ConceptsModified != 1 ? "s" : "") modified</span>
                                </div>
                            }
                            @if (WhatsNew.ConceptsDeleted > 0)
                            {
                                <div class="summary-item deleted">
                                    <i class="bi bi-dash-circle"></i>
                                    <span>@WhatsNew.ConceptsDeleted concept@(WhatsNew.ConceptsDeleted != 1 ? "s" : "") deleted</span>
                                </div>
                            }
                            @if (WhatsNew.RelationshipsAdded > 0)
                            {
                                <div class="summary-item added">
                                    <i class="bi bi-plus-circle"></i>
                                    <span>@WhatsNew.RelationshipsAdded relationship@(WhatsNew.RelationshipsAdded != 1 ? "s" : "") added</span>
                                </div>
                            }
                            @if (WhatsNew.RelationshipsModified > 0)
                            {
                                <div class="summary-item modified">
                                    <i class="bi bi-pencil"></i>
                                    <span>@WhatsNew.RelationshipsModified relationship@(WhatsNew.RelationshipsModified != 1 ? "s" : "") modified</span>
                                </div>
                            }
                            @if (WhatsNew.RelationshipsDeleted > 0)
                            {
                                <div class="summary-item deleted">
                                    <i class="bi bi-dash-circle"></i>
                                    <span>@WhatsNew.RelationshipsDeleted relationship@(WhatsNew.RelationshipsDeleted != 1 ? "s" : "") deleted</span>
                                </div>
                            }
                        </div>
                    </div>
                }

                @if (WhatsNew?.RecentActivities?.Any() == true)
                {
                    <div class="recent-activities">
                        <h6>Recent Changes</h6>
                        <div class="activity-list">
                            @foreach (var activity in WhatsNew.RecentActivities.Take(10))
                            {
                                <div class="activity-item">
                                    <div class="activity-icon @GetActivityClass(activity.ActivityType)">
                                        <i class="bi @GetActivityIcon(activity.ActivityType)"></i>
                                    </div>
                                    <div class="activity-details">
                                        <div class="activity-description">@activity.Description</div>
                                        <div class="activity-meta">
                                            <span class="activity-actor">@activity.ActorName</span>
                                            <span class="activity-time">@FormatTimestamp(activity.CreatedAt)</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                        @if (WhatsNew.RecentActivities.Count > 10)
                        {
                            <div class="more-activities">
                                + @(WhatsNew.RecentActivities.Count - 10) more change@(WhatsNew.RecentActivities.Count - 10 != 1 ? "s" : "")
                            </div>
                        }
                    </div>
                }
                else if (!HasChanges)
                {
                    <div class="no-changes-message">
                        <i class="bi bi-check-circle"></i>
                        <p>You're all caught up! No changes since your last visit.</p>
                    </div>
                }

                <div class="whats-new-actions">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="DismissPanel">
                        @(HasChanges ? "Got it, thanks!" : "Close")
                    </button>
                </div>
            </div>
        }
    </div>
}

@code {
    [Parameter]
    public WhatsNewDto? WhatsNew { get; set; }

    [Parameter]
    public EventCallback OnDismiss { get; set; }

    [Parameter]
    public bool StartExpanded { get; set; } = false;  // Start collapsed by default

    private bool IsExpanded { get; set; }
    private bool IsDismissed { get; set; }
    private bool HasChanges => WhatsNew != null && WhatsNew.TotalChanges > 0;

    protected override void OnParametersSet()
    {
        Console.WriteLine($"[WhatsNewPanel] OnParametersSet - WhatsNew: {(WhatsNew != null ? $"{WhatsNew.TotalChanges} changes" : "null")}, IsDismissed: {IsDismissed}, HasChanges: {HasChanges}");
        if (!IsDismissed)
        {
            // Only auto-expand if there are actual changes
            IsExpanded = HasChanges && StartExpanded;
            Console.WriteLine($"[WhatsNewPanel] Setting IsExpanded to {IsExpanded}");
        }
    }

    private void ToggleExpanded()
    {
        if (!IsDismissed)
        {
            IsExpanded = !IsExpanded;
        }
    }

    private async Task DismissPanel()
    {
        IsDismissed = true;
        await OnDismiss.InvokeAsync();
    }

    private string FormatTimestamp(DateTime timestamp)
    {
        var now = DateTime.UtcNow;
        var diff = now - timestamp;

        if (diff.TotalMinutes < 1)
            return "just now";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes} minute{((int)diff.TotalMinutes != 1 ? "s" : "")} ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours} hour{((int)diff.TotalHours != 1 ? "s" : "")} ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays} day{((int)diff.TotalDays != 1 ? "s" : "")} ago";
        if (diff.TotalDays < 30)
            return $"{(int)(diff.TotalDays / 7)} week{((int)(diff.TotalDays / 7) != 1 ? "s" : "")} ago";

        return timestamp.ToLocalTime().ToString("MMM d, yyyy");
    }

    private string GetActivityClass(string activityType)
    {
        return activityType.ToLower() switch
        {
            "create" => "activity-create",
            "update" => "activity-update",
            "delete" => "activity-delete",
            _ => ""
        };
    }

    private string GetActivityIcon(string activityType)
    {
        return activityType.ToLower() switch
        {
            "create" => "bi-plus-circle-fill",
            "update" => "bi-pencil-fill",
            "delete" => "bi-dash-circle-fill",
            _ => "bi-circle-fill"
        };
    }
}
