@using Eidos.Models
@using Eidos.Models.Enums
@using Eidos.Services.Interfaces
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject IConceptService ConceptService
@inject ILogger<MindMapView> Logger

<div class="mind-map-container" style="position: relative; width: 100%; height: @Height;">
    <!-- Canvas -->
    <div id="@CanvasId"
         class="mind-map-canvas"
         style="width: 100%; height: 100%; background: var(--canvas-bg); border-radius: 0.5rem; overflow: hidden;">
    </div>

    <!-- Breadcrumb Navigation (Top) -->
    @if (breadcrumbs.Any())
    {
        <div class="breadcrumb-overlay">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <button class="btn btn-link btn-sm p-0 text-decoration-none" @onclick="@(() => NavigateTo(null))">
                            <i class="bi bi-house-door"></i> Root
                        </button>
                    </li>
                    @foreach (var crumb in breadcrumbs)
                    {
                        var isLast = crumb == breadcrumbs.Last();
                        <li class="breadcrumb-item @(isLast ? "active" : "")" aria-current="@(isLast ? "page" : null)">
                            @if (!isLast)
                            {
                                <button class="btn btn-link btn-sm p-0 text-decoration-none" @onclick="@(() => NavigateTo(crumb.ConceptId))">
                                    @crumb.Name
                                </button>
                            }
                            else
                            {
                                <span>@crumb.Name</span>
                            }
                        </li>
                    }
                </ol>
            </nav>
        </div>
    }

    <!-- Modern Control Panel (Bottom Right) -->
    <div class="control-panel">
        <!-- Zoom Level Indicator -->
        <div class="control-group mb-3">
            <label class="control-label">
                <i class="bi bi-zoom-in"></i> Zoom
            </label>
            <div class="zoom-display">@($"{currentZoom:F1}x")</div>
            <div class="btn-group-vertical w-100 mt-2" role="group">
                <button class="btn btn-sm btn-outline-primary" @onclick="ZoomIn" title="Zoom In (Ctrl + =)">
                    <i class="bi bi-plus-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" @onclick="ZoomOut" title="Zoom Out (Ctrl + -)">
                    <i class="bi bi-dash-lg"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" @onclick="ResetZoom" title="Reset Zoom (Ctrl + 0)">
                    <i class="bi bi-aspect-ratio"></i>
                </button>
            </div>
        </div>

        <!-- Display Options -->
        <div class="control-group">
            <label class="control-label">
                <i class="bi bi-sliders"></i> Display
            </label>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showLabels"
                       @bind="showLabels" @bind:after="RefreshGraph">
                <label class="form-check-label small" for="showLabels">Labels</label>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showDetails"
                       @bind="showDetails" @bind:after="RefreshGraph">
                <label class="form-check-label small" for="showDetails">Details</label>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="dimParents"
                       @bind="dimParentContext">
                <label class="form-check-label small" for="dimParents">Dim Context</label>
            </div>
        </div>
    </div>

    <!-- Floating Action Button for Add Concept -->
    @if (CanAdd)
    {
        <div class="fab-container">
            <button class="btn btn-primary rounded-circle fab-button"
                    @onclick="HandleAddConcept"
                    title="Add Concept (Ctrl + N)">
                <i class="bi bi-plus-lg"></i>
            </button>
        </div>
    }
</div>

@code {
    [Parameter, EditorRequired]
    public Ontology? Ontology { get; set; }

    [Parameter]
    public string Height { get; set; } = "calc(100vh - 200px)";

    [Parameter]
    public bool CanAdd { get; set; } = true;

    [Parameter]
    public EventCallback<int> OnConceptClick { get; set; }

    [Parameter]
    public EventCallback OnAddConceptClick { get; set; }

    private string CanvasId = $"mindmap-{Guid.NewGuid():N}";
    private bool hasRendered = false;
    private double currentZoom = 1.0;
    private bool showLabels = true;
    private bool showDetails = false;
    private bool dimParentContext = true;
    private int? focusedConceptId = null;
    private List<BreadcrumbItem> breadcrumbs = new();

    private class BreadcrumbItem
    {
        public int ConceptId { get; set; }
        public string Name { get; set; } = string.Empty;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && Ontology != null)
        {
            try
            {
                await InitializeMindMap();
                hasRendered = true;
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Failed to initialize mind map for ontology {OntologyId}", Ontology.Id);
            }
        }
    }

    private async Task InitializeMindMap()
    {
        if (Ontology == null) return;

        var concepts = Ontology.Concepts.Select(c => new
        {
            id = $"c{c.Id}",
            label = c.Name,
            definition = c.Definition,
            category = c.Category,
            color = c.Color,
            x = c.PositionX ?? 0,
            y = c.PositionY ?? 0
        }).ToList();

        var relationships = Ontology.Relationships.Select(r => new
        {
            id = $"e{r.Id}",
            source = $"c{r.SourceConceptId}",
            target = $"c{r.TargetConceptId}",
            label = r.Label ?? r.RelationType,
            type = r.RelationType
        }).ToList();

        await JS.InvokeVoidAsync("initializeMindMap", CanvasId, concepts, relationships, new
        {
            zoomEnabled = true,
            minZoom = 0.1,
            maxZoom = double.MaxValue, // Infinite zoom
            showLabels = showLabels,
            showDetails = showDetails,
            dimParents = dimParentContext,
            focusedConcept = focusedConceptId
        });
    }

    private async Task RefreshGraph()
    {
        if (!hasRendered) return;

        await JS.InvokeVoidAsync("updateMindMapOptions", CanvasId, new
        {
            showLabels = showLabels,
            showDetails = showDetails,
            dimParents = dimParentContext,
            focusedConcept = focusedConceptId
        });
    }

    private async Task ZoomIn()
    {
        currentZoom = Math.Min(currentZoom * 1.3, 100.0); // Cap at 100x
        await JS.InvokeVoidAsync("setMindMapZoom", CanvasId, currentZoom);
    }

    private async Task ZoomOut()
    {
        currentZoom = Math.Max(currentZoom / 1.3, 0.1); // Minimum 0.1x
        await JS.InvokeVoidAsync("setMindMapZoom", CanvasId, currentZoom);
    }

    private async Task ResetZoom()
    {
        currentZoom = 1.0;
        focusedConceptId = null;
        breadcrumbs.Clear();
        await JS.InvokeVoidAsync("resetMindMapZoom", CanvasId);
    }

    private async Task NavigateTo(int? conceptId)
    {
        focusedConceptId = conceptId;

        // Update breadcrumbs
        if (conceptId == null)
        {
            breadcrumbs.Clear();
        }
        else
        {
            var concept = Ontology?.Concepts.FirstOrDefault(c => c.Id == conceptId);
            if (concept != null)
            {
                // Find position in breadcrumbs
                var index = breadcrumbs.FindIndex(b => b.ConceptId == conceptId);
                if (index >= 0)
                {
                    // Remove everything after this
                    breadcrumbs = breadcrumbs.Take(index + 1).ToList();
                }
            }
        }

        await RefreshGraph();
    }

    private async Task DrillInto(int conceptId)
    {
        var concept = Ontology?.Concepts.FirstOrDefault(c => c.Id == conceptId);
        if (concept == null) return;

        // Add to breadcrumbs
        breadcrumbs.Add(new BreadcrumbItem
        {
            ConceptId = conceptId,
            Name = concept.Name
        });

        focusedConceptId = conceptId;
        await RefreshGraph();
        await JS.InvokeVoidAsync("drillIntoMindMapNode", CanvasId, $"c{conceptId}");
    }

    private async Task HandleAddConcept()
    {
        await OnAddConceptClick.InvokeAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (hasRendered)
        {
            try
            {
                await JS.InvokeVoidAsync("disposeMindMap", CanvasId);
            }
            catch
            {
                // Component may have been torn down
            }
        }
    }
}
