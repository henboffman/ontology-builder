@page "/workspace/{WorkspaceId:int}"
@using Eidos.Models
@using Eidos.Services
@using Eidos.Services.Interfaces
@using Eidos.Data.Repositories
@using Eidos.Components.Workspace
@using Eidos.Components.Shared
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@rendermode InteractiveServer

<PageTitle>@(workspace?.Name ?? "Workspace") - Eidos</PageTitle>

<link href="css/workspace-view.css" rel="stylesheet" />
<link href="css/components/workspace-quick-switcher.css" rel="stylesheet" />
<link href="css/image-lightbox.css" rel="stylesheet" />
<script src="js/wikiLinkEditor.js"></script>
<script src="js/wikiLinkPreview.js"></script>
<script src="js/workspaceKeyboardHandler.js"></script>
<script src="js/fileDownload.js"></script>
<script src="js/markdownToolbar.js"></script>
<script src="js/noteGraphVisualization.js"></script>

<!-- Quick Switcher Component -->
<WorkspaceQuickSwitcher @ref="quickSwitcher" WorkspaceId="@WorkspaceId" OnNoteSelected="HandleQuickSwitcherNoteSelected"
    OnHide="HandleQuickSwitcherHide" />

<!-- Tag Management Dialog -->
@if (currentUserId != null)
{
    <TagManagementDialog IsOpen="@showTagManagement" IsOpenChanged="@((value) => showTagManagement = value)"
        WorkspaceId="@WorkspaceId" UserId="@currentUserId" OnTagsChanged="@HandleTagsChanged" />
}

<!-- Markdown Import Dialog -->
@if (currentUserId != null)
{
    <MarkdownImportDialog IsOpen="@showMarkdownImport" IsOpenChanged="@((value) => showMarkdownImport = value)"
        WorkspaceId="@WorkspaceId" UserId="@currentUserId" OnImportComplete="@HandleImportComplete" />
}

<!-- Share Modal -->
@if (workspace?.Ontology != null)
{
    <ShareModal Show="@showShareDialog" ShowChanged="@((bool show) => showShareDialog = show)"
        OntologyId="@workspace.Ontology.Id" OntologyName="@workspace.Ontology.Name" UserId="@workspace.Ontology.UserId" />
}


<!-- Delete Confirmation Dialog -->
@if (showDeleteConfirmation)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle text-danger me-2"></i>Delete Note</h5>
                    <button type="button" class="btn-close" @onclick="CancelDelete"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong>"@noteToDelete?.Title"</strong>?</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        This action cannot be undone. The note and all its content will be permanently deleted.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@deleting">
                        @if (deleting)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <span>Delete</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

<!-- Export Dialog -->
@if (showExportDialog)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-download me-2"></i>Export Notes</h5>
                    <button type="button" class="btn-close" @onclick="CloseExportDialog"></button>
                </div>
                <div class="modal-body">
                    @if (exportInProgress)
                    {
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary mb-2" role="status">
                                <span class="visually-hidden">Exporting...</span>
                            </div>
                            <p class="text-muted">Preparing export...</p>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-primary">
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>Tip:</strong> To export a single note, click the <i class="bi bi-download"></i> button in
                            the note editor.
                        </div>

                        <p class="mb-3">Export all workspace notes as markdown files with YAML frontmatter in a ZIP archive.</p>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>What's included:</strong>
                            <ul class="mb-0 mt-2">
                                <li>All notes with their markdown content</li>
                                <li>YAML frontmatter with metadata (title, tags, dates)</li>
                                <li>Individual .md files packaged in a ZIP file</li>
                            </ul>
                        </div>

                        @if (notes.Any())
                        {
                            <p class="mb-2"><strong>@notes.Count</strong> note(s) will be exported</p>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                No notes to export in this workspace.
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseExportDialog"
                        disabled="@exportInProgress">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="ExportAllNotes"
                        disabled="@(exportInProgress || !notes.Any())">
                        <i class="bi bi-download me-1"></i>Export All as ZIP
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

<div class="workspace-container">
    @if (loading)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading workspace...</span>
            </div>
            <p class="mt-3">Loading workspace...</p>
        </div>
    }
    else if (workspace == null)
    {
        <div class="error-state">
            <h3>Workspace Not Found</h3>
            <p>The workspace you're looking for doesn't exist or you don't have access to it.</p>
            <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/"))">
                Go to Home
            </button>
        </div>
    }
    else
    {
        <!-- Workspace Header -->
        <div class="workspace-header">
            <div class="workspace-title">
                <h2>@workspace.Name</h2>
                @if (!string.IsNullOrWhiteSpace(workspace.Description))
                {
                    <p class="text-muted small mb-0">@workspace.Description</p>
                }
            </div>
            <div class="workspace-actions ms-auto d-flex gap-2">
                <!-- Share & Settings -->
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-info" @onclick="ShowShareDialog"
                        title="Share this workspace with others">
                        <i class="bi bi-share"></i> Share
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="ShowSettingsDialog" title="Edit workspace settings">
                        <i class="bi bi-gear"></i> Settings
                    </button>
                </div>

                <!-- Import & Export -->
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-success" @onclick="() => showMarkdownImport = true"
                        title="Import markdown files">
                        <i class="bi bi-upload"></i> Import
                    </button>
                    <button class="btn btn-outline-success" @onclick="ShowExportDialog" title="Export workspace notes">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>

                <!-- Switch to Ontology -->
                @if (workspace.Ontology != null)
                {
                    <button class="btn btn-sm workspace-switch-btn"
                        @onclick="@(() => Navigation.NavigateTo($"ontology/{workspace.Ontology.Id}"))"
                        title="Switch to Ontology Graph View">
                        <i class="bi bi-diagram-3 me-1"></i> Switch to Ontology
                    </button>
                }
            </div>
        </div>

        <!-- Keyboard Shortcuts Hint Banner -->
        @if (!hideKeyboardHints)
        {
            <div class="keyboard-hints-banner">
                <div class="hints-content">
                    <i class="bi bi-keyboard me-2"></i>
                    <span class="hints-text">
                        <kbd>Cmd/Ctrl + K</kbd> Quick switcher
                        <span class="mx-2">•</span>
                        <kbd>Cmd/Ctrl + E</kbd> Toggle preview
                        <span class="mx-2">•</span>
                        Type <code>[[Concept]]</code> to create links
                    </span>
                </div>
                <button class="btn-close-hints" @onclick="DismissKeyboardHints" title="Dismiss">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        }

        <!-- Three-Pane Layout (Obsidian-style) -->
        <div class="three-pane-layout">
            <!-- Left Pane: File Explorer -->
            <div class="pane pane-left">
                <div class="pane-header-vertical">
                    <div class="pane-header-row">
                        <h5>Notes</h5>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-link text-decoration-none p-1" @onclick="ToggleCondensedView"
                                title="@(isCondensedView ? "Comfortable View" : "Condensed View")">
                                <i class="bi @(isCondensedView ? "bi-list" : "bi-list-task")"></i>
                            </button>
                        </div>
                    </div>
                    <div class="pane-actions-compact">
                        <button class="btn btn-sm btn-link text-decoration-none p-1" @onclick="CreateNewNote"
                            title="New Note">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                        <button class="btn btn-sm btn-link text-decoration-none p-1"
                            @onclick="() => showMarkdownImport = true" title="Import Markdown Files">
                            <i class="bi bi-file-earmark-arrow-up"></i>
                        </button>
                        @if (workspace.Ontology != null)
                        {
                            <button class="btn btn-sm btn-link text-decoration-none p-1"
                                @onclick="@(() => Navigation.NavigateTo($"ontology/{workspace.Ontology.Id}"))"
                                title="View in Graph">
                                <i class="bi bi-diagram-3"></i>
                            </button>
                        }
                    </div>
                    <div class="pane-search">
                        <div class="position-relative">
                            <input type="search" class="form-control form-control-sm"
                                placeholder="Search notes (title & content)..." value="@searchTerm"
                                @oninput="OnSearchInputChanged" />
                            @if (searching)
                            {
                                <span class="position-absolute top-50 end-0 translate-middle-y me-2"
                                    style="pointer-events: none;">
                                    <span class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Searching...</span>
                                    </span>
                                </span>
                            }
                        </div>
                    </div>
                    <div class="pane-tags-section">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted text-uppercase"
                                style="font-weight: 600; font-size: 0.7rem; letter-spacing: 0.05em;">
                                <i class="bi bi-folder2 me-1"></i>Folders
                            </small>
                            <div class="d-flex gap-2">
                                @if (workspaceTags.Any())
                                {
                                    <button class="btn btn-sm btn-link text-decoration-none p-0" @onclick="ToggleTagsExpanded"
                                        title="@(isTagsExpanded ? "Collapse folders" : "Expand folders")">
                                        <i class="bi @(isTagsExpanded ? "bi-chevron-up" : "bi-chevron-down")"
                                            style="font-size: 0.75rem;"></i>
                                    </button>
                                }
                                <button class="btn btn-sm btn-link text-decoration-none p-0"
                                    @onclick="() => showTagManagement = true" title="Manage Tags">
                                    <i class="bi bi-gear-fill" style="font-size: 0.75rem;"></i>
                                </button>
                            </div>
                        </div>
                        @if (isTagsExpanded)
                        {
                            <!-- All Notes Folder (Always visible) -->
                            <div class="virtual-folder-item @(selectedTagFilter == null ? "active" : "")"
                                @onclick="ClearTagFilter">
                                <i class="bi bi-folder2 folder-icon"></i>
                                <span class="folder-name">All Notes</span>
                                <span class="folder-count">@notes.Count</span>
                            </div>

                            <!-- Tag-based Virtual Folders -->
                            @if (workspaceTags.Any())
                            {
                                <div class="virtual-folders-list">
                                    @foreach (var tagWithCount in workspaceTags)
                                    {
                                        <div class="virtual-folder-item @(selectedTagFilter == tagWithCount.Tag.Id ? "active" : "")"
                                            @onclick="() => ToggleTagFilter(tagWithCount.Tag.Id)">
                                            <i class="bi @(selectedTagFilter == tagWithCount.Tag.Id ? "bi-folder2-open" : "bi-folder2") folder-icon"
                                                style="color: @tagWithCount.Tag.Color;"></i>
                                            <span class="folder-name">@tagWithCount.Tag.Name</span>
                                            <span class="folder-count">@tagWithCount.NoteCount</span>
                                        </div>
                                    }
                                </div>
                            }
                        }
                    </div>
                    <div class="note-filters-section">
                        <div class="note-type-filter">
                            <div class="btn-group btn-group-sm w-100" role="group">
                                <button type="button"
                                    class="btn @(noteTypeFilter == NoteTypeFilter.All ? "btn-primary" : "btn-outline-secondary")"
                                    @onclick="() => SetNoteTypeFilter(NoteTypeFilter.All)">
                                    All
                                </button>
                                <button type="button"
                                    class="btn @(noteTypeFilter == NoteTypeFilter.Notes ? "btn-primary" : "btn-outline-secondary")"
                                    @onclick="() => SetNoteTypeFilter(NoteTypeFilter.Notes)">
                                    Notes
                                </button>
                                <button type="button"
                                    class="btn @(noteTypeFilter == NoteTypeFilter.Concepts ? "btn-primary" : "btn-outline-secondary")"
                                    @onclick="() => SetNoteTypeFilter(NoteTypeFilter.Concepts)">
                                    Concepts
                                </button>
                            </div>
                        </div>
                        <div class="note-sort-dropdown">
                            <select class="form-select form-select-sm" @bind="noteSortOption" @bind:after="OnSortChanged">
                                <option value="@NoteSortOption.TitleAsc">Title (A-Z)</option>
                                <option value="@NoteSortOption.TitleDesc">Title (Z-A)</option>
                                <option value="@NoteSortOption.ModifiedDesc">Modified (Newest)</option>
                                <option value="@NoteSortOption.ModifiedAsc">Modified (Oldest)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="pane-content">
                    <!-- Note List View -->
                    @if (notes.Any())
                    {
                        <div class="note-list">
                            @foreach (var note in FilteredNotes)
                            {
                                <div class="note-item @(selectedNote?.Id == note.Id ? "active" : "") @(isCondensedView ? "condensed" : "")"
                                    @onclick="@(() => SelectNote(note.Id))">
                                    @if (isCondensedView)
                                    {
                                        <div class="d-flex align-items-center gap-2">
                                            @if (note.IsConceptNote)
                                            {
                                                <span class="badge bg-primary" style="font-size: 0.5rem; padding: 0.1rem 0.3rem;">C</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary" style="font-size: 0.5rem; padding: 0.1rem 0.3rem;">N</span>
                                            }
                                            <span class="note-item-title">@note.Title</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="note-item-title">
                                            @note.Title
                                        </div>
                                        <div class="note-item-meta d-flex align-items-center gap-2">
                                            @if (note.IsConceptNote)
                                            {
                                                <span class="badge bg-primary"
                                                    style="font-size: 0.55rem; padding: 0.15rem 0.35rem;">Concept</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary"
                                                    style="font-size: 0.55rem; padding: 0.15rem 0.35rem;">Note</span>
                                            }
                                            <small class="text-muted">
                                                @note.UpdatedAt.ToString("MMM d, yyyy")
                                            </small>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <p class="text-muted">No notes yet</p>
                            <button class="btn btn-sm btn-outline-primary" @onclick="CreateNewNote">
                                Create your first note
                            </button>
                        </div>
                    }
                </div>
            </div>

            <!-- Center Pane: Markdown Editor or Graph View -->
            <div class="pane pane-center">
                @if (showNoteGraph)
                {
                    <!-- Graph View Mode -->
                    <div class="pane-header">
                        <h5 class="mb-0">Note Network</h5>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-primary" @onclick="ToggleNoteView" title="Switch to Note Editor">
                                <i class="bi bi-pencil me-1"></i> Back to Notes
                            </button>
                        </div>
                    </div>
                    <div class="pane-content p-0" style="height: calc(100% - 60px);">
                        <NoteGraphView WorkspaceId="@WorkspaceId" OnNoteSelected="@((noteId) => SelectNote(noteId))" />
                    </div>
                }
                else if (selectedNote != null)
                {
                    <div class="pane-header">
                        <input type="text" class="form-control note-title-input" @bind="selectedNote.Title"
                            placeholder="Note title..." />
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-sm btn-outline-primary" @onclick="ToggleNoteView" title="View Note Network">
                                <i class="bi bi-diagram-3 me-1"></i> Graph
                            </button>
                            @if (!showPreview)
                            {
                                <AutoSaveIndicator Status="@autoSaveStatus" />
                            }
                            <button class="btn btn-sm btn-link text-decoration-none"
                                @onclick="() => ExportSingleNote(selectedNote.Id)" title="Export as Markdown">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-sm btn-link text-decoration-none text-danger"
                                @onclick="ShowDeleteConfirmation" title="Delete Note">
                                <i class="bi bi-trash"></i>
                            </button>
                            <button
                                class="btn btn-sm btn-link text-decoration-none edit-toggle-btn @(showPreview ? "" : "active")"
                                @onclick="TogglePreview">
                                <i class="bi @(showPreview ? "bi-pencil" : "bi-eye")"></i>
                                <span class="ms-1">@(showPreview ? "Edit" : "Preview")</span>
                            </button>
                        </div>
                    </div>
                    <div class="pane-content">
                        @if (!showPreview)
                        {
                            <!-- Markdown Formatting Toolbar -->
                            <div class="markdown-toolbar">
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-btn" @onclick="InsertBold" title="Bold (Ctrl+B)">
                                        <i class="bi bi-type-bold"></i>
                                    </button>
                                    <button type="button" class="toolbar-btn" @onclick="InsertItalic" title="Italic (Ctrl+I)">
                                        <i class="bi bi-type-italic"></i>
                                    </button>
                                    <button type="button" class="toolbar-btn" @onclick="InsertStrikethrough" title="Strikethrough">
                                        <i class="bi bi-type-strikethrough"></i>
                                    </button>
                                </div>
                                <div class="toolbar-divider"></div>
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-btn" @onclick="InsertHeading1" title="Heading 1">
                                        <i class="bi bi-type-h1"></i>
                                    </button>
                                    <button type="button" class="toolbar-btn" @onclick="InsertHeading2" title="Heading 2">
                                        <i class="bi bi-type-h2"></i>
                                    </button>
                                    <button type="button" class="toolbar-btn" @onclick="InsertHeading3" title="Heading 3">
                                        <i class="bi bi-type-h3"></i>
                                    </button>
                                </div>
                                <div class="toolbar-divider"></div>
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-btn" @onclick="InsertLink" title="Link">
                                        <i class="bi bi-link-45deg"></i>
                                    </button>
                                    <button type="button" class="toolbar-btn" @onclick="InsertInlineCode" title="Inline Code">
                                        <i class="bi bi-code"></i>
                                    </button>
                                    <button type="button" class="toolbar-btn" @onclick="InsertQuote" title="Quote">
                                        <i class="bi bi-quote"></i>
                                    </button>
                                </div>
                                <div class="toolbar-divider"></div>
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-btn" @onclick="InsertBulletList" title="Bullet List">
                                        <i class="bi bi-list-ul"></i>
                                    </button>
                                    <button type="button" class="toolbar-btn" @onclick="InsertNumberedList" title="Numbered List">
                                        <i class="bi bi-list-ol"></i>
                                    </button>
                                    <button type="button" class="toolbar-btn" @onclick="InsertTaskList" title="Task List">
                                        <i class="bi bi-check-square"></i>
                                    </button>
                                </div>
                                <div class="toolbar-divider"></div>
                                <div class="toolbar-group">
                                    <button type="button" class="toolbar-btn" @onclick="InsertCodeBlock" title="Code Block">
                                        <i class="bi bi-file-code"></i>
                                    </button>
                                    <button type="button" class="toolbar-btn" @onclick="InsertTable" title="Table">
                                        <i class="bi bi-table"></i>
                                    </button>
                                    <button type="button" class="toolbar-btn" @onclick="InsertHorizontalRule"
                                        title="Horizontal Rule">
                                        <i class="bi bi-dash-lg"></i>
                                    </button>
                                </div>
                            </div>

                            <textarea @ref="editorTextArea" id="note-editor-@selectedNote.Id" class="markdown-editor"
                    @bind="noteContent" @bind:event="oninput" @bind:after="OnNoteContentChanged"
                    placeholder="Start typing... Use [[concept name]] to link to concepts"></textarea>
                        }
                        else
                        {
                            <div id="markdown-preview" class="markdown-preview">
                                @((MarkupString)MarkdownRenderer.RenderToHtml(noteContent))
                            </div>
                        }
                    </div>
                }
                else if (creatingNote)
                {
                    <div class="pane-header">
                        <input type="text" class="form-control note-title-input" @bind="newNoteTitle" @bind:event="oninput"
                            @bind:after="OnNewNoteTitleChanged" placeholder="Note title..." />
                        <div class="pane-actions">
                            <button class="btn btn-sm btn-outline-secondary" @onclick="CancelNewNote">
                                Cancel
                            </button>
                            <button class="btn btn-sm btn-success" @onclick="SaveNewNote" disabled="@saving">
                                Create
                            </button>
                        </div>
                    </div>
                    <div class="pane-content">
                        <textarea @ref="newNoteTextArea" id="note-editor-new" class="markdown-editor" @bind="noteContent"
                    @bind:event="oninput" @bind:after="OnNewNoteContentChanged"
                    placeholder="Start typing... Use [[concept name]] to link to concepts"></textarea>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <i class="bi bi-journal-text" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="text-muted mt-3">Select a note to view or edit</p>
                        <p class="text-muted small mb-3">
                            Tip: Use <code>[[concept name]]</code> to create links to concepts
                        </p>
                        <button class="btn btn-outline-primary" @onclick="ToggleNoteView" title="View Note Network">
                            <i class="bi bi-diagram-3 me-1"></i> View Note Network
                        </button>
                    </div>
                }
            </div>

            <!-- Right Pane: Tags, Related Concepts & Backlinks -->
            <div class="pane pane-right @(isRightPaneCollapsed ? "collapsed" : "")">
                @if (isRightPaneCollapsed)
                {
                    <div class="collapsed-sidebar-label">
                        <span>Tags & Backlinks</span>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary collapse-toggle-btn collapsed-btn"
                        @onclick="ToggleRightPane" title="Show sidebar">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                }

                <!-- Tags Section -->
                @if (selectedNote != null && currentUserId != null)
                {
                    <div class="pane-header">
                        <h5>Tags</h5>
                        @if (!isRightPaneCollapsed)
                        {
                            <button class="btn btn-sm btn-outline-secondary collapse-toggle-btn" @onclick="ToggleRightPane"
                                title="Hide sidebar">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        }
                    </div>
                    <div class="pane-content" style="border-bottom: 1px solid var(--bs-border-color); padding: 1rem;">
                        <TagSelector WorkspaceId="@WorkspaceId" UserId="@currentUserId" SelectedTags="@selectedNoteTags"
                            SelectedTagsChanged="@HandleNoteTagsChanged" />
                    </div>
                }

                <!-- Smart Suggestions Section (for non-concept notes) -->
                @if (selectedNote != null && !selectedNote.IsConceptNote && workspace?.Ontology != null)
                {
                    <div class="pane-header">
                        <h5>Smart Suggestions</h5>
                    </div>
                    <div class="pane-content" style="border-bottom: 1px solid var(--bs-border-color); padding: 1rem;">
                        <SmartSuggestionsPanel ConceptLinks="@currentNoteConceptLinks" IsLoading="@loadingConceptLinks"
                            OntologyId="@workspace.Ontology.Id" CurrentNoteContent="@noteContent"
                            OnContentUpdate="@HandleWikiLinkCreation" />
                    </div>
                }

                <!-- Related Concepts Section (for concept notes only) -->
                @if (selectedNote?.IsConceptNote == true && selectedNote.LinkedConceptId.HasValue)
                {
                    <div class="pane-header">
                        <h5>Related Concepts</h5>
                    </div>
                    <div class="pane-content" style="border-bottom: 1px solid var(--border-color, #dee2e6);">
                        @if (relatedConcepts.Any())
                        {
                            <div class="note-list">
                                @foreach (var concept in relatedConcepts)
                                {
                                    <div class="note-item condensed" @onclick="@(() => NavigateToConceptNote(concept.Name))">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-primary" style="font-size: 0.5rem; padding: 0.1rem 0.3rem;">C</span>
                                            <span class="note-item-title">@concept.Name</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="empty-state">
                                <p class="text-muted small">No related concepts</p>
                            </div>
                        }
                    </div>
                }

                <!-- Backlinks Section -->
                <div class="pane-header">
                    <h5>Backlinks</h5>
                </div>
                <div class="pane-content">
                    @if (selectedNote != null && backlinks.Any())
                    {
                        <div class="backlinks-list">
                            @foreach (var backlink in backlinks)
                            {
                                <div class="backlink-item" @onclick="@(() => SelectNote(backlink.SourceNoteId))">
                                    <div class="backlink-source">
                                        <i class="bi bi-file-text me-1"></i>
                                        @backlink.SourceNote?.Title
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(backlink.ContextSnippet))
                                    {
                                        <div class="backlink-context">
                                            <small class="text-muted">"...@backlink.ContextSnippet..."</small>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else if (selectedNote != null)
                    {
                        <div class="empty-state">
                            <p class="text-muted small">No backlinks</p>
                            <p class="text-muted" style="font-size: 0.7rem;">
                                Other notes that link to "[[<span>@selectedNote.Title</span>]]" will appear here
                            </p>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <p class="text-muted small">Select a note to view backlinks</p>
                        </div>
                    }
                </div>

                <!-- Markdown Tips Section -->
                <div class="pane-header" style="cursor: pointer;" @onclick="ToggleMarkdownTips">
                    <h5>
                        <i class="bi bi-question-circle me-1"></i> Markdown Tips
                    </h5>
                    <i class="bi @(showMarkdownTips ? "bi-chevron-down" : "bi-chevron-right")"></i>
                </div>
                @if (showMarkdownTips)
                {
                    <div class="pane-content">
                        <div class="markdown-tips">
                            <div class="tip-item">
                                <code>**bold**</code>
                                <span class="tip-result"><strong>bold</strong></span>
                            </div>
                            <div class="tip-item">
                                <code>*italic*</code>
                                <span class="tip-result"><em>italic</em></span>
                            </div>
                            <div class="tip-item">
                                <code># Heading 1</code>
                                <span class="tip-result text-muted">Large heading</span>
                            </div>
                            <div class="tip-item">
                                <code>## Heading 2</code>
                                <span class="tip-result text-muted">Medium heading</span>
                            </div>
                            <div class="tip-item">
                                <code>- List item</code>
                                <span class="tip-result text-muted">Bullet point</span>
                            </div>
                            <div class="tip-item">
                                <code>1. Numbered</code>
                                <span class="tip-result text-muted">Numbered list</span>
                            </div>
                            <div class="tip-item">
                                <code>[Link](url)</code>
                                <span class="tip-result text-muted">Hyperlink</span>
                            </div>
                            <div class="tip-item">
                                <code>[[Concept]]</code>
                                <span class="tip-result text-muted">Wiki link</span>
                            </div>
                            <div class="tip-item">
                                <code>`code`</code>
                                <span class="tip-result"><code>inline code</code></span>
                            </div>
                            <div class="tip-item">
                                <code>```code```</code>
                                <span class="tip-result text-muted">Code block</span>
                            </div>
                            <div class="tip-item">
                                <code>> Quote</code>
                                <span class="tip-result text-muted">Blockquote</span>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>