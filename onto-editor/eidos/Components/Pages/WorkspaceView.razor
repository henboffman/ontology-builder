@page "/workspace/{WorkspaceId:int}"
@using Eidos.Models
@using Eidos.Services
@using Eidos.Services.Interfaces
@using Eidos.Components.Workspace
@using Eidos.Components.Shared
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.JSInterop
@inject WorkspaceService WorkspaceService
@inject NoteService NoteService
@inject TagService TagService
@inject AutoSaveService AutoSaveService
@inject IConceptService ConceptService
@inject IRelationshipService RelationshipService
@inject MarkdownRenderingService MarkdownRenderer
@inject MarkdownExportService MarkdownExportService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager Navigation
@inject ToastService ToastService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>@(workspace?.Name ?? "Workspace") - Eidos</PageTitle>

<link href="css/workspace-view.css" rel="stylesheet" />
<link href="css/components/workspace-quick-switcher.css" rel="stylesheet" />
<link href="css/image-lightbox.css" rel="stylesheet" />
<script src="js/wikiLinkEditor.js"></script>
<script src="js/wikiLinkPreview.js"></script>
<script src="js/workspaceKeyboardHandler.js"></script>
<script src="js/fileDownload.js"></script>

<!-- Quick Switcher Component -->
<WorkspaceQuickSwitcher @ref="quickSwitcher"
                        WorkspaceId="@WorkspaceId"
                        OnNoteSelected="HandleQuickSwitcherNoteSelected"
                        OnHide="HandleQuickSwitcherHide" />

<!-- Tag Management Dialog -->
@if (currentUserId != null)
{
    <TagManagementDialog IsOpen="@showTagManagement"
                         IsOpenChanged="@((value) => showTagManagement = value)"
                         WorkspaceId="@WorkspaceId"
                         UserId="@currentUserId"
                         OnTagsChanged="@HandleTagsChanged" />
}

<!-- Markdown Import Dialog -->
@if (currentUserId != null)
{
    <MarkdownImportDialog IsOpen="@showMarkdownImport"
                          IsOpenChanged="@((value) => showMarkdownImport = value)"
                          WorkspaceId="@WorkspaceId"
                          UserId="@currentUserId"
                          OnImportComplete="@HandleImportComplete" />
}

<!-- Share Modal -->
@if (workspace?.Ontology != null)
{
    <ShareModal Show="@showShareDialog"
                ShowChanged="@((bool show) => showShareDialog = show)"
                OntologyId="@workspace.Ontology.Id"
                OntologyName="@workspace.Ontology.Name"
                UserId="@workspace.Ontology.UserId" />
}


<!-- Export Dialog -->
@if (showExportDialog)
{
    <div class="modal show d-block" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-download me-2"></i>Export Notes</h5>
                    <button type="button" class="btn-close" @onclick="CloseExportDialog"></button>
                </div>
                <div class="modal-body">
                    @if (exportInProgress)
                    {
                        <div class="text-center py-3">
                            <div class="spinner-border text-primary mb-2" role="status">
                                <span class="visually-hidden">Exporting...</span>
                            </div>
                            <p class="text-muted">Preparing export...</p>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-primary">
                            <i class="bi bi-lightbulb me-2"></i>
                            <strong>Tip:</strong> To export a single note, click the <i class="bi bi-download"></i> button in the note editor.
                        </div>

                        <p class="mb-3">Export all workspace notes as markdown files with YAML frontmatter in a ZIP archive.</p>

                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>What's included:</strong>
                            <ul class="mb-0 mt-2">
                                <li>All notes with their markdown content</li>
                                <li>YAML frontmatter with metadata (title, tags, dates)</li>
                                <li>Individual .md files packaged in a ZIP file</li>
                            </ul>
                        </div>

                        @if (notes.Any())
                        {
                            <p class="mb-2"><strong>@notes.Count</strong> note(s) will be exported</p>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                No notes to export in this workspace.
                            </div>
                        }
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseExportDialog" disabled="@exportInProgress">
                        Cancel
                    </button>
                    <button type="button"
                            class="btn btn-primary"
                            @onclick="ExportAllNotes"
                            disabled="@(exportInProgress || !notes.Any())">
                        <i class="bi bi-download me-1"></i>Export All as ZIP
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop show"></div>
}

<div class="workspace-container">
    @if (loading)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading workspace...</span>
            </div>
            <p class="mt-3">Loading workspace...</p>
        </div>
    }
    else if (workspace == null)
    {
        <div class="error-state">
            <h3>Workspace Not Found</h3>
            <p>The workspace you're looking for doesn't exist or you don't have access to it.</p>
            <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/"))">
                Go to Home
            </button>
        </div>
    }
    else
    {
        <!-- Workspace Header -->
        <div class="workspace-header">
            <div class="workspace-title">
                <h2>@workspace.Name</h2>
                @if (!string.IsNullOrWhiteSpace(workspace.Description))
                {
                    <p class="text-muted small mb-0">@workspace.Description</p>
                }
            </div>
            <div class="workspace-actions ms-auto d-flex gap-2">
                <!-- Share & Settings -->
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-info"
                            @onclick="ShowShareDialog"
                            title="Share this workspace with others">
                        <i class="bi bi-share"></i> Share
                    </button>
                    <button class="btn btn-outline-secondary"
                            @onclick="ShowSettingsDialog"
                            title="Edit workspace settings">
                        <i class="bi bi-gear"></i> Settings
                    </button>
                </div>

                <!-- Import & Export -->
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-success"
                            @onclick="() => showMarkdownImport = true"
                            title="Import markdown files">
                        <i class="bi bi-upload"></i> Import
                    </button>
                    <button class="btn btn-outline-success"
                            @onclick="ShowExportDialog"
                            title="Export workspace notes">
                        <i class="bi bi-download"></i> Export
                    </button>
                </div>

                <!-- Switch to Ontology -->
                @if (workspace.Ontology != null)
                {
                    <button class="btn btn-sm btn-outline-light"
                            @onclick="@(() => Navigation.NavigateTo($"/ontology/{workspace.Ontology.Id}"))"
                            title="Switch to Ontology Graph View">
                        <i class="bi bi-diagram-3 me-1"></i> Switch to Ontology
                    </button>
                }
            </div>
        </div>

        <!-- Keyboard Shortcuts Hint Banner -->
        @if (!hideKeyboardHints)
        {
            <div class="keyboard-hints-banner">
                <div class="hints-content">
                    <i class="bi bi-keyboard me-2"></i>
                    <span class="hints-text">
                        <kbd>Cmd/Ctrl + K</kbd> Quick switcher
                        <span class="mx-2">•</span>
                        <kbd>Cmd/Ctrl + E</kbd> Toggle preview
                        <span class="mx-2">•</span>
                        Type <code>[[Concept]]</code> to create links
                    </span>
                </div>
                <button class="btn-close-hints" @onclick="DismissKeyboardHints" title="Dismiss">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        }

        <!-- Three-Pane Layout (Obsidian-style) -->
        <div class="three-pane-layout">
            <!-- Left Pane: File Explorer -->
            <div class="pane pane-left">
                <div class="pane-header-vertical">
                    <div class="pane-header-row">
                        <h5>Notes</h5>
                        <button class="btn btn-sm btn-link text-decoration-none p-1"
                                @onclick="ToggleCondensedView"
                                title="@(isCondensedView ? "Comfortable View" : "Condensed View")">
                            <i class="bi @(isCondensedView ? "bi-list" : "bi-list-task")"></i>
                        </button>
                    </div>
                    <div class="pane-actions-compact">
                        <button class="btn btn-sm btn-link text-decoration-none p-1"
                                @onclick="CreateNewNote"
                                title="New Note">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                        <button class="btn btn-sm btn-link text-decoration-none p-1"
                                @onclick="() => showMarkdownImport = true"
                                title="Import Markdown Files">
                            <i class="bi bi-file-earmark-arrow-up"></i>
                        </button>
                        @if (workspace.Ontology != null)
                        {
                            <button class="btn btn-sm btn-link text-decoration-none p-1"
                                    @onclick="@(() => Navigation.NavigateTo($"/ontology/{workspace.Ontology.Id}"))"
                                    title="View in Graph">
                                <i class="bi bi-diagram-3"></i>
                            </button>
                        }
                    </div>
                    <div class="pane-search">
                        <input type="search"
                               class="form-control form-control-sm"
                               placeholder="Search notes..."
                               @bind="searchTerm"
                               @bind:event="oninput"
                               @bind:after="OnSearchChanged" />
                    </div>
                    <div class="pane-tags-section">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted text-uppercase" style="font-weight: 600; font-size: 0.7rem; letter-spacing: 0.05em;">Tags</small>
                            <div class="d-flex gap-2">
                                @if (workspaceTags.Any())
                                {
                                    <button class="btn btn-sm btn-link text-decoration-none p-0"
                                            @onclick="ToggleTagsExpanded"
                                            title="@(isTagsExpanded ? "Collapse tags" : "Expand tags")">
                                        <i class="bi @(isTagsExpanded ? "bi-chevron-up" : "bi-chevron-down")" style="font-size: 0.75rem;"></i>
                                    </button>
                                }
                                <button class="btn btn-sm btn-link text-decoration-none p-0"
                                        @onclick="() => showTagManagement = true"
                                        title="Manage Tags">
                                    <i class="bi bi-gear-fill" style="font-size: 0.75rem;"></i>
                                </button>
                            </div>
                        </div>
                        @if (workspaceTags.Any() && isTagsExpanded)
                        {
                            <div class="workspace-tags-list">
                                @foreach (var tagWithCount in workspaceTags)
                                {
                                    <div class="workspace-tag-item @(selectedTagFilter == tagWithCount.Tag.Id ? "active" : "")"
                                         @onclick="() => ToggleTagFilter(tagWithCount.Tag.Id)">
                                        <TagBadge Tag="@tagWithCount.Tag" Size="small" />
                                        <span class="tag-count-badge">@tagWithCount.NoteCount</span>
                                    </div>
                                }
                            </div>
                            @if (selectedTagFilter != null)
                            {
                                <button class="btn btn-sm btn-link text-decoration-none p-0 mt-2"
                                        @onclick="ClearTagFilter"
                                        style="font-size: 0.75rem;">
                                    <i class="bi bi-x-circle me-1"></i>Clear filter
                                </button>
                            }
                        }
                    </div>
                    <div class="note-filters-section">
                        <div class="note-type-filter">
                            <div class="btn-group btn-group-sm w-100" role="group">
                                <button type="button"
                                        class="btn @(noteTypeFilter == NoteTypeFilter.All ? "btn-primary" : "btn-outline-secondary")"
                                        @onclick="() => SetNoteTypeFilter(NoteTypeFilter.All)">
                                    All
                                </button>
                                <button type="button"
                                        class="btn @(noteTypeFilter == NoteTypeFilter.Notes ? "btn-primary" : "btn-outline-secondary")"
                                        @onclick="() => SetNoteTypeFilter(NoteTypeFilter.Notes)">
                                    Notes
                                </button>
                                <button type="button"
                                        class="btn @(noteTypeFilter == NoteTypeFilter.Concepts ? "btn-primary" : "btn-outline-secondary")"
                                        @onclick="() => SetNoteTypeFilter(NoteTypeFilter.Concepts)">
                                    Concepts
                                </button>
                            </div>
                        </div>
                        <div class="note-sort-dropdown">
                            <select class="form-select form-select-sm"
                                    @bind="noteSortOption"
                                    @bind:after="OnSortChanged">
                                <option value="@NoteSortOption.TitleAsc">Title (A-Z)</option>
                                <option value="@NoteSortOption.TitleDesc">Title (Z-A)</option>
                                <option value="@NoteSortOption.ModifiedDesc">Modified (Newest)</option>
                                <option value="@NoteSortOption.ModifiedAsc">Modified (Oldest)</option>
                            </select>
                        </div>
                    </div> 
                </div>
                <div class="pane-content">
                    @if (notes.Any())
                    {
                        <div class="note-list">
                            @foreach (var note in FilteredNotes)
                            {
                                <div class="note-item @(selectedNote?.Id == note.Id ? "active" : "") @(isCondensedView ? "condensed" : "")"
                                     @onclick="@(() => SelectNote(note.Id))">
                                    @if (isCondensedView)
                                    {
                                        <div class="d-flex align-items-center gap-2">
                                            @if (note.IsConceptNote)
                                            {
                                                <span class="badge bg-primary" style="font-size: 0.5rem; padding: 0.1rem 0.3rem;">C</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary" style="font-size: 0.5rem; padding: 0.1rem 0.3rem;">N</span>
                                            }
                                            <span class="note-item-title">@note.Title</span>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="note-item-title">
                                            @note.Title
                                        </div>
                                        <div class="note-item-meta d-flex align-items-center gap-2">
                                            @if (note.IsConceptNote)
                                            {
                                                <span class="badge bg-primary" style="font-size: 0.55rem; padding: 0.15rem 0.35rem;">Concept</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary" style="font-size: 0.55rem; padding: 0.15rem 0.35rem;">Note</span>
                                            }
                                            <small class="text-muted">
                                                @note.UpdatedAt.ToString("MMM d, yyyy")
                                            </small>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <p class="text-muted">No notes yet</p>
                            <button class="btn btn-sm btn-outline-primary" @onclick="CreateNewNote">
                                Create your first note
                            </button>
                        </div>
                    }
                </div>
            </div>

            <!-- Center Pane: Markdown Editor -->
            <div class="pane pane-center">
                @if (selectedNote != null)
                {
                    <div class="pane-header">
                        <input type="text"
                               class="form-control note-title-input"
                               @bind="selectedNote.Title"
                               placeholder="Note title..." />
                        <div class="d-flex align-items-center gap-2">
                            @if (!showPreview)
                            {
                                <AutoSaveIndicator Status="@autoSaveStatus" />
                            }
                            <button class="btn btn-sm btn-link text-decoration-none"
                                    @onclick="() => ExportSingleNote(selectedNote.Id)"
                                    title="Export as Markdown">
                                <i class="bi bi-download"></i>
                            </button>
                            <button class="btn btn-sm btn-link text-decoration-none edit-toggle-btn @(showPreview ? "" : "active")"
                                    @onclick="TogglePreview">
                                <i class="bi @(showPreview ? "bi-pencil" : "bi-eye")"></i>
                                <span class="ms-1">@(showPreview ? "Edit" : "Preview")</span>
                            </button>
                        </div>
                    </div>
                    <div class="pane-content">
                        @if (!showPreview)
                        {
                            <textarea @ref="editorTextArea"
                                      id="note-editor-@selectedNote.Id"
                                      class="markdown-editor"
                                      @bind="noteContent"
                                      @bind:event="oninput"
                                      @bind:after="OnNoteContentChanged"
                                      placeholder="Start typing... Use [[concept name]] to link to concepts"></textarea>
                        }
                        else
                        {
                            <div id="markdown-preview" class="markdown-preview">
                                @((MarkupString)MarkdownRenderer.RenderToHtml(noteContent))
                            </div>
                        }
                    </div>
                }
                else if (creatingNote)
                {
                    <div class="pane-header">
                        <input type="text"
                               class="form-control note-title-input"
                               @bind="newNoteTitle"
                               placeholder="Note title..." />
                        <div class="pane-actions">
                            <button class="btn btn-sm btn-outline-secondary"
                                    @onclick="CancelNewNote">
                                Cancel
                            </button>
                            <button class="btn btn-sm btn-success"
                                    @onclick="SaveNewNote"
                                    disabled="@saving">
                                Create
                            </button>
                        </div>
                    </div>
                    <div class="pane-content">
                        <textarea @ref="newNoteTextArea"
                                  id="note-editor-new"
                                  class="markdown-editor"
                                  @bind="noteContent"
                                  @bind:event="oninput"
                                  placeholder="Start typing... Use [[concept name]] to link to concepts"></textarea>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <i class="bi bi-journal-text" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="text-muted mt-3">Select a note to view or edit</p>
                        <p class="text-muted small">
                            Tip: Use <code>[[concept name]]</code> to create links to concepts
                        </p>
                    </div>
                }
            </div>

            <!-- Right Pane: Tags, Related Concepts & Backlinks -->
            <div class="pane pane-right @(isRightPaneCollapsed ? "collapsed" : "")">
                @if (isRightPaneCollapsed)
                {
                    <div class="collapsed-sidebar-label">
                        <span>Tags & Backlinks</span>
                    </div>
                    <button class="btn btn-sm btn-outline-secondary collapse-toggle-btn collapsed-btn"
                            @onclick="ToggleRightPane"
                            title="Show sidebar">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                }

                <!-- Tags Section -->
                @if (selectedNote != null && currentUserId != null)
                {
                    <div class="pane-header">
                        <h5>Tags</h5>
                        @if (!isRightPaneCollapsed)
                        {
                            <button class="btn btn-sm btn-outline-secondary collapse-toggle-btn"
                                    @onclick="ToggleRightPane"
                                    title="Hide sidebar">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        }
                    </div>
                    <div class="pane-content" style="border-bottom: 1px solid var(--bs-border-color); padding: 1rem;">
                        <TagSelector WorkspaceId="@WorkspaceId"
                                     UserId="@currentUserId"
                                     SelectedTags="@selectedNoteTags"
                                     SelectedTagsChanged="@HandleNoteTagsChanged" />
                    </div>
                }

                <!-- Related Concepts Section (for concept notes only) -->
                @if (selectedNote?.IsConceptNote == true && selectedNote.LinkedConceptId.HasValue)
                {
                    <div class="pane-header">
                        <h5>Related Concepts</h5>
                    </div>
                    <div class="pane-content" style="border-bottom: 1px solid var(--border-color, #dee2e6);">
                        @if (relatedConcepts.Any())
                        {
                            <div class="note-list">
                                @foreach (var concept in relatedConcepts)
                                {
                                    <div class="note-item condensed" @onclick="@(() => NavigateToConceptNote(concept.Name))">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge bg-primary" style="font-size: 0.5rem; padding: 0.1rem 0.3rem;">C</span>
                                            <span class="note-item-title">@concept.Name</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="empty-state">
                                <p class="text-muted small">No related concepts</p>
                            </div>
                        }
                    </div>
                }

                <!-- Backlinks Section -->
                <div class="pane-header">
                    <h5>Backlinks</h5>
                </div>
                <div class="pane-content">
                    @if (selectedNote != null && backlinks.Any())
                    {
                        <div class="backlinks-list">
                            @foreach (var backlink in backlinks)
                            {
                                <div class="backlink-item" @onclick="@(() => SelectNote(backlink.SourceNoteId))">
                                    <div class="backlink-source">
                                        <i class="bi bi-file-text me-1"></i>
                                        @backlink.SourceNote?.Title
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(backlink.ContextSnippet))
                                    {
                                        <div class="backlink-context">
                                            <small class="text-muted">"...@backlink.ContextSnippet..."</small>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    }
                    else if (selectedNote != null)
                    {
                        <div class="empty-state">
                            <p class="text-muted small">No backlinks</p>
                            <p class="text-muted" style="font-size: 0.7rem;">
                                Other notes that link to "[[<span>@selectedNote.Title</span>]]" will appear here
                            </p>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <p class="text-muted small">Select a note to view backlinks</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private enum NoteTypeFilter
    {
        All,
        Notes,
        Concepts
    }

    private enum NoteSortOption
    {
        TitleAsc,
        TitleDesc,
        ModifiedDesc,
        ModifiedAsc
    }

    [Parameter]
    public int WorkspaceId { get; set; }

    private Workspace? workspace;
    private List<Note> notes = new();
    private Note? selectedNote;
    private List<NoteLink> backlinks = new();
    private List<Concept> relatedConcepts = new();

    private string noteContent = string.Empty;
    private string searchTerm = string.Empty;
    private string newNoteTitle = string.Empty;

    private bool loading = true;
    private bool saving = false;
    private bool showPreview = false;
    private bool creatingNote = false;
    private bool isCondensedView = true; // Default to condensed view (VS Code style)
    private bool hideKeyboardHints = false;
    private bool isRightPaneCollapsed = false;
    private bool isTagsExpanded = true; // Default to expanded

    private string? currentUserId;

    // Auto-save
    private AutoSaveStatus autoSaveStatus = AutoSaveStatus.Idle;
    private DateTime? lastSavedTime = null;

    // Quick Switcher
    private WorkspaceQuickSwitcher? quickSwitcher;

    // Tags
    private List<(Tag Tag, int NoteCount)> workspaceTags = new();
    private int? selectedTagFilter = null;
    private bool showTagManagement = false;
    private bool showMarkdownImport = false;
    private List<Tag> selectedNoteTags = new();

    // Note type filter and sorting
    private NoteTypeFilter noteTypeFilter = NoteTypeFilter.All;
    private NoteSortOption noteSortOption = NoteSortOption.ModifiedDesc;

    // Element references for JavaScript interop
    private ElementReference editorTextArea;
    private ElementReference newNoteTextArea;
    private IJSObjectReference? wikiLinkEditorModule;
    private IJSObjectReference? imageUploadModule;
    private IJSObjectReference? imageLightboxModule;
    private DotNetObjectReference<WorkspaceView>? dotNetHelper;

    private IEnumerable<Note> FilteredNotes
    {
        get
        {
            var filtered = notes.AsEnumerable();

            // Apply note type filter
            if (noteTypeFilter == NoteTypeFilter.Notes)
            {
                filtered = filtered.Where(n => !n.IsConceptNote);
            }
            else if (noteTypeFilter == NoteTypeFilter.Concepts)
            {
                filtered = filtered.Where(n => n.IsConceptNote);
            }

            // Apply search filter
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                filtered = filtered.Where(n => n.Title.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
            }

            // Apply tag filter
            if (selectedTagFilter.HasValue)
            {
                filtered = filtered.Where(n => noteTagsCache.ContainsKey(n.Id) && noteTagsCache[n.Id].Any(t => t.Id == selectedTagFilter.Value));
            }

            // Apply sorting
            filtered = noteSortOption switch
            {
                NoteSortOption.TitleAsc => filtered.OrderBy(n => n.Title),
                NoteSortOption.TitleDesc => filtered.OrderByDescending(n => n.Title),
                NoteSortOption.ModifiedDesc => filtered.OrderByDescending(n => n.UpdatedAt),
                NoteSortOption.ModifiedAsc => filtered.OrderBy(n => n.UpdatedAt),
                _ => filtered.OrderByDescending(n => n.UpdatedAt)
            };

            return filtered;
        }
    }

    // Cache of note tags for filtering
    private Dictionary<int, List<Tag>> noteTagsCache = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        currentUserId = authState.User.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(currentUserId))
        {
            Navigation.NavigateTo("/Account/Login");
            return;
        }

        await LoadWorkspaceAsync();

        // Subscribe to auto-save status changes
        AutoSaveService.StatusChanged += OnAutoSaveStatusChanged;

        // Check for noteId query parameter and auto-select that note
        var uri = new Uri(Navigation.Uri);
        var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var noteIdParam = queryParams["noteId"];

        if (!string.IsNullOrEmpty(noteIdParam) && int.TryParse(noteIdParam, out int noteIdToSelect))
        {
            await SelectNote(noteIdToSelect);
        }
    }

    private async Task LoadWorkspaceAsync()
    {
        try
        {
            loading = true;

            workspace = await WorkspaceService.GetWorkspaceAsync(WorkspaceId, currentUserId!, includeOntology: true);

            if (workspace != null)
            {
                // If workspace doesn't have an ontology loaded, it might be a legacy workspace
                // Try to reload it to ensure the Ontology navigation property is populated
                if (workspace.Ontology == null)
                {
                    Console.WriteLine($"[WorkspaceView] Workspace {WorkspaceId} has no ontology loaded, reloading...");
                    workspace = await WorkspaceService.GetWorkspaceAsync(WorkspaceId, currentUserId!, includeOntology: true);

                    if (workspace?.Ontology != null)
                    {
                        Console.WriteLine($"[WorkspaceView] Successfully loaded ontology {workspace.Ontology.Id} for workspace {WorkspaceId}");
                    }
                    else
                    {
                        Console.WriteLine($"[WorkspaceView] Workspace {WorkspaceId} still has no ontology after reload");
                    }
                }

                await LoadNotesAsync();
                await LoadTagsAsync();
            }
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading workspace: {ex.Message}");
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadNotesAsync()
    {
        try
        {
            notes = await NoteService.GetWorkspaceNotesAsync(WorkspaceId, currentUserId!);
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading notes: {ex.Message}");
        }
    }

    private async Task SelectNote(int noteId)
    {
        try
        {
            Console.WriteLine($"[SelectNote] Selecting note ID: {noteId}");

            // Save current note if it was being edited
            if (selectedNote != null && !string.IsNullOrEmpty(noteContent))
            {
                Console.WriteLine($"[SelectNote] Saving current note first");
                await SaveNote();
            }

            var note = await NoteService.GetNoteWithContentAsync(noteId, currentUserId!);

            if (note != null)
            {
                Console.WriteLine($"[SelectNote] Loaded note: {note.Title} (ID: {note.Id})");
                selectedNote = note;
                noteContent = note.Content?.MarkdownContent ?? string.Empty;
                showPreview = true; // Default to preview mode
                creatingNote = false;

                Console.WriteLine($"[SelectNote] Set selectedNote, calling StateHasChanged");

                // Load backlinks and related concepts
                // If this is a concept note, get backlinks via the concept
                if (note.LinkedConceptId.HasValue)
                {
                    backlinks = await NoteService.GetBacklinksAsync(note.LinkedConceptId.Value);

                    // Load related concepts for concept notes
                    await LoadRelatedConceptsAsync(note.LinkedConceptId.Value);
                }
                else
                {
                    relatedConcepts = new List<Concept>();

                    // For regular notes, we need to find a concept with matching name
                    // This allows backlinks to work for any note via [[note title]]
                    if (workspace?.Ontology != null)
                    {
                        var concepts = await ConceptService.GetByOntologyIdAsync(workspace.Ontology.Id);
                        var matchingConcept = concepts.FirstOrDefault(c =>
                            c.Name.Equals(note.Title, StringComparison.OrdinalIgnoreCase));

                        if (matchingConcept != null)
                        {
                            backlinks = await NoteService.GetBacklinksAsync(matchingConcept.Id);
                        }
                        else
                        {
                            backlinks = new List<NoteLink>();
                        }
                    }
                    else
                    {
                        backlinks = new List<NoteLink>();
                    }
                }

                // Load tags for the selected note from cache (or load if not cached)
                if (noteTagsCache.ContainsKey(note.Id))
                {
                    selectedNoteTags = noteTagsCache[note.Id];
                }
                else
                {
                    selectedNoteTags = await TagService.GetNoteTagsAsync(note.Id);
                    noteTagsCache[note.Id] = selectedNoteTags;
                }

                // Force UI update
                Console.WriteLine($"[SelectNote] Calling StateHasChanged to update UI");
                StateHasChanged();
            }
            else
            {
                Console.WriteLine($"[SelectNote] Note not found for ID: {noteId}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[SelectNote] Error: {ex.Message}");
            ToastService.ShowError($"Error loading note: {ex.Message}");
        }
    }

    private void CreateNewNote()
    {
        creatingNote = true;
        selectedNote = null;
        newNoteTitle = string.Empty;
        noteContent = string.Empty;
        showPreview = false;
    }

    private void CancelNewNote()
    {
        creatingNote = false;
        newNoteTitle = string.Empty;
        noteContent = string.Empty;
    }

    private async Task SaveNewNote()
    {
        if (string.IsNullOrWhiteSpace(newNoteTitle))
        {
            ToastService.ShowWarning("Please enter a note title");
            return;
        }

        try
        {
            saving = true;

            var note = await NoteService.CreateNoteAsync(
                WorkspaceId,
                currentUserId!,
                newNoteTitle,
                noteContent
            );

            notes.Insert(0, note);
            ToastService.ShowSuccess($"Created note '{newNoteTitle}'");

            // Select the new note
            creatingNote = false;
            await SelectNote(note.Id);
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error creating note: {ex.Message}");
        }
        finally
        {
            saving = false;
        }
    }

    private async Task SaveNote()
    {
        if (selectedNote == null)
        {
            return;
        }

        try
        {
            saving = true;

            await NoteService.UpdateNoteContentAsync(selectedNote.Id, currentUserId!, noteContent);

            // Reload notes to show any auto-created concept notes from [[wiki-links]]
            await LoadNotesAsync();

            // Update local note timestamp
            var note = notes.FirstOrDefault(n => n.Id == selectedNote.Id);
            if (note != null)
            {
                note.UpdatedAt = DateTime.UtcNow;
            }

            ToastService.ShowSuccess("Note saved");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error saving note: {ex.Message}");
        }
        finally
        {
            saving = false;
        }
    }

    private void OnNoteContentChanged()
    {
        if (selectedNote != null && currentUserId != null)
        {
            // Queue auto-save
            AutoSaveService.QueueSave(selectedNote.Id, selectedNote.Title, noteContent, currentUserId);
        }
    }

    private void OnAutoSaveStatusChanged(object? sender, AutoSaveStatusChangedEventArgs e)
    {
        // Only update UI for the currently selected note
        if (selectedNote != null && e.NoteId == selectedNote.Id)
        {
            autoSaveStatus = e.Status;

            // Update last saved time when status changes to Saved
            if (e.Status == AutoSaveStatus.Saved)
            {
                lastSavedTime = DateTime.UtcNow;
            }

            InvokeAsync(StateHasChanged);
        }
    }

    [JSInvokable]
    public async Task TogglePreview()
    {
        showPreview = !showPreview;

        // Initialize lightbox when switching to preview mode
        if (showPreview)
        {
            await Task.Delay(50); // Small delay to ensure DOM is updated
            await InitializeImageLightbox();
        }
    }

    private void ToggleCondensedView()
    {
        isCondensedView = !isCondensedView;
    }

    private void ToggleRightPane()
    {
        isRightPaneCollapsed = !isRightPaneCollapsed;
    }

    private void ToggleTagsExpanded()
    {
        isTagsExpanded = !isTagsExpanded;
    }

    private void DismissKeyboardHints()
    {
        hideKeyboardHints = true;
    }

    private void OnSearchChanged()
    {
        // Search is handled by FilteredNotes property
        StateHasChanged();
    }

    // JavaScript interop for wiki-link editor and preview
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Create .NET object reference for JS callbacks
                dotNetHelper = DotNetObjectReference.Create(this);

                // Wait a moment for scripts to load, then initialize handlers
                await Task.Delay(100);
                await JSRuntime.InvokeVoidAsync("WorkspaceKeyboardHandler.initialize", dotNetHelper);
                await JSRuntime.InvokeVoidAsync("initializeWikiLinkPreview", dotNetHelper);

                // Initialize wiki-link editor when a note is selected
                if (selectedNote != null)
                {
                    await InitializeWikiLinkEditor();
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error initializing wiki-link handlers: {ex.Message}");
            }
        }
        else if (selectedNote != null || creatingNote)
        {
            // Re-initialize when note changes
            await InitializeWikiLinkEditor();

            // Initialize lightbox if in preview mode
            if (selectedNote != null && showPreview)
            {
                await Task.Delay(50); // Small delay to ensure DOM is updated
                await InitializeImageLightbox();
            }
        }
    }

    private async Task InitializeWikiLinkEditor()
    {
        try
        {
            var elementId = creatingNote ? "note-editor-new" : $"note-editor-{selectedNote?.Id}";

            await JSRuntime.InvokeVoidAsync(
                "WikiLinkEditor.initialize",
                elementId,
                dotNetHelper
            );

            // Initialize image upload for the editor
            await InitializeImageUpload(elementId);
        }
        catch (Exception ex)
        {
            // Silently fail if editor not ready yet
            Console.WriteLine($"WikiLinkEditor init failed (may retry): {ex.Message}");
        }
    }

    private async Task InitializeImageUpload(string elementId)
    {
        try
        {
            // Load image upload module if not already loaded
            if (imageUploadModule == null)
            {
                imageUploadModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./js/imageUpload.js");
            }

            // Get the note ID for upload
            var noteId = creatingNote ? 0 : selectedNote?.Id ?? 0;

            // Initialize image upload for this editor
            if (noteId > 0 && WorkspaceId > 0)
            {
                await imageUploadModule.InvokeVoidAsync(
                    "initializeImageUpload",
                    elementId,
                    noteId,
                    WorkspaceId
                );
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ImageUpload init failed: {ex.Message}");
        }
    }

    private async Task InitializeImageLightbox()
    {
        try
        {
            // Load image lightbox module if not already loaded
            if (imageLightboxModule == null)
            {
                imageLightboxModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "import", "./js/imageLightbox.js");
            }

            // Initialize lightbox for the markdown preview
            await imageLightboxModule.InvokeVoidAsync(
                "initializeImageLightbox",
                "markdown-preview"
            );
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ImageLightbox init failed: {ex.Message}");
        }
    }

    private async Task LoadRelatedConceptsAsync(int conceptId)
    {
        try
        {
            if (workspace?.Ontology == null)
            {
                relatedConcepts = new List<Concept>();
                return;
            }

            // Get all relationships for this concept
            var relationships = await RelationshipService.GetByConceptIdAsync(conceptId);
            var conceptIds = new HashSet<int>();

            foreach (var rel in relationships)
            {
                // Add both source and target concepts (excluding the current concept)
                if (rel.SourceConceptId != conceptId)
                {
                    conceptIds.Add(rel.SourceConceptId);
                }
                if (rel.TargetConceptId != conceptId)
                {
                    conceptIds.Add(rel.TargetConceptId);
                }
            }

            // Load the concept details
            var allConcepts = await ConceptService.GetByOntologyIdAsync(workspace.Ontology.Id);
            relatedConcepts = allConcepts
                .Where(c => conceptIds.Contains(c.Id))
                .OrderBy(c => c.Name)
                .ToList();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error loading related concepts: {ex.Message}");
            relatedConcepts = new List<Concept>();
        }
    }

    private async Task NavigateToConceptNote(string conceptName)
    {
        try
        {
            Console.WriteLine($"[NavigateToConceptNote] Looking for concept note: '{conceptName}'");
            Console.WriteLine($"[NavigateToConceptNote] Total notes: {notes.Count}, Concept notes: {notes.Count(n => n.IsConceptNote)}");

            // Find the concept note by name
            var note = notes.FirstOrDefault(n =>
                n.IsConceptNote &&
                n.Title.Equals(conceptName, StringComparison.OrdinalIgnoreCase));

            if (note != null)
            {
                Console.WriteLine($"[NavigateToConceptNote] Found note: {note.Title} (ID: {note.Id})");
                await SelectNote(note.Id);
            }
            else
            {
                Console.WriteLine($"[NavigateToConceptNote] Note not found for: '{conceptName}'");
                Console.WriteLine($"[NavigateToConceptNote] Available concept notes:");
                foreach (var n in notes.Where(n => n.IsConceptNote))
                {
                    Console.WriteLine($"  - '{n.Title}' (ID: {n.Id})");
                }
                ToastService.ShowInfo($"Note for '{conceptName}' not found");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[NavigateToConceptNote] Error: {ex.Message}");
            ToastService.ShowError($"Error navigating to concept note: {ex.Message}");
        }
    }

    /// <summary>
    /// Called from JavaScript when user Ctrl+Clicks a [[wiki-link]]
    /// </summary>
    [JSInvokable]
    public async Task NavigateToConcept(string conceptName)
    {
        try
        {
            // First, try to find a note for this concept
            await NavigateToConceptNote(conceptName);
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Error navigating to concept: {ex.Message}");
        }
    }

    // Quick Switcher handlers
    [JSInvokable]
    public async Task ShowQuickSwitcher()
    {
        if (quickSwitcher != null && !string.IsNullOrEmpty(currentUserId))
        {
            await quickSwitcher.ShowAsync(currentUserId);
        }
    }

    private async Task HandleQuickSwitcherNoteSelected(Note note)
    {
        if (note != null)
        {
            await SelectNote(note.Id);
        }
    }

    private void HandleQuickSwitcherHide()
    {
        // Quick switcher closed, nothing specific to do
        StateHasChanged();
    }

    // Tag management methods
    private async Task LoadTagsAsync()
    {
        try
        {
            workspaceTags = await TagService.GetWorkspaceTagsWithCountsAsync(WorkspaceId, currentUserId!);
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to load tags: {ex.Message}");
        }
    }

    private void ToggleTagFilter(int tagId)
    {
        if (selectedTagFilter == tagId)
        {
            selectedTagFilter = null;
        }
        else
        {
            selectedTagFilter = tagId;
        }
        StateHasChanged();
    }

    private void ClearTagFilter()
    {
        selectedTagFilter = null;
        StateHasChanged();
    }

    private void SetNoteTypeFilter(NoteTypeFilter filter)
    {
        noteTypeFilter = filter;
        StateHasChanged();
    }

    private void OnSortChanged()
    {
        StateHasChanged();
    }

    private async Task HandleTagsChanged()
    {
        await LoadTagsAsync();
        StateHasChanged();
    }

    private async Task HandleImportComplete()
    {
        // Reload notes and tags after import
        await LoadNotesAsync();
        await LoadTagsAsync();
        ToastService.ShowSuccess("Markdown files imported successfully");
        StateHasChanged();
    }

    private async Task HandleNoteTagsChanged(List<Tag> newTags)
    {
        if (selectedNote == null || string.IsNullOrEmpty(currentUserId))
            return;

        try
        {
            // Update the tag assignments
            await TagService.ReplaceNoteTagsAsync(selectedNote.Id, newTags.Select(t => t.Id).ToList(), currentUserId, WorkspaceId);

            // Update local state
            selectedNoteTags = newTags;

            // Update the cache
            noteTagsCache[selectedNote.Id] = newTags;

            // Reload workspace tags to update counts
            await LoadTagsAsync();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to update tags: {ex.Message}");
        }
    }

    // === Toolbar Actions ===

    private bool showShareDialog = false;
    private bool showExportDialog = false;
    private bool exportInProgress = false;

    private void ShowShareDialog()
    {
        showShareDialog = true;
    }

    private void ShowSettingsDialog()
    {
        // Navigate to the ontology settings page
        if (workspace?.Ontology != null)
        {
            Navigation.NavigateTo($"/ontology/{workspace.Ontology.Id}/settings");
        }
    }

    private void ShowExportDialog()
    {
        showExportDialog = true;
    }

    private void CloseExportDialog()
    {
        showExportDialog = false;
        exportInProgress = false;
    }

    private async Task ExportAllNotes()
    {
        if (string.IsNullOrEmpty(currentUserId) || workspace == null)
            return;

        try
        {
            exportInProgress = true;
            StateHasChanged();

            // Generate ZIP file with all notes
            var zipBytes = await MarkdownExportService.ExportNotesAsZipAsync(WorkspaceId, currentUserId);

            // Generate filename
            var sanitizedWorkspaceName = SanitizeFilename(workspace.Name);
            var timestamp = DateTime.Now.ToString("yyyy-MM-dd_HHmmss");
            var filename = $"{sanitizedWorkspaceName}_notes_{timestamp}.zip";

            // Trigger download via JavaScript
            await JSRuntime.InvokeVoidAsync("downloadFile", filename, "application/zip", zipBytes);

            ToastService.ShowSuccess($"Exported {notes.Count} note(s) successfully");
            CloseExportDialog();
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to export notes: {ex.Message}");
            exportInProgress = false;
            StateHasChanged();
        }
    }

    private async Task ExportSingleNote(int noteId)
    {
        if (string.IsNullOrEmpty(currentUserId) || workspace == null)
            return;

        try
        {
            // Generate markdown for single note
            var markdown = await MarkdownExportService.ExportSingleNoteAsync(noteId, WorkspaceId, currentUserId);

            // Find the note to get its title
            var note = notes.FirstOrDefault(n => n.Id == noteId);
            if (note == null)
            {
                ToastService.ShowError("Note not found");
                return;
            }

            // Generate filename
            var sanitizedTitle = SanitizeFilename(note.Title);
            var timestamp = DateTime.Now.ToString("yyyy-MM-dd_HHmmss");
            var filename = $"{sanitizedTitle}_{timestamp}.md";

            // Convert markdown string to byte array for download
            var markdownBytes = System.Text.Encoding.UTF8.GetBytes(markdown);

            // Trigger download via JavaScript
            await JSRuntime.InvokeVoidAsync("downloadFile", filename, "text/markdown", markdownBytes);

            ToastService.ShowSuccess($"Exported '{note.Title}' successfully");
        }
        catch (Exception ex)
        {
            ToastService.ShowError($"Failed to export note: {ex.Message}");
        }
    }

    private string SanitizeFilename(string filename)
    {
        var invalid = Path.GetInvalidFileNameChars();
        return string.Join("_", filename.Split(invalid, StringSplitOptions.RemoveEmptyEntries)).TrimEnd('.');
    }

    // Cleanup
    public async ValueTask DisposeAsync()
    {
        try
        {
            // Unsubscribe from auto-save status changes
            AutoSaveService.StatusChanged -= OnAutoSaveStatusChanged;

            // Force save any pending auto-save before disposing
            if (selectedNote != null && currentUserId != null)
            {
                await AutoSaveService.ForceSaveAsync(selectedNote.Id, selectedNote.Title, noteContent, currentUserId);
            }

            if (dotNetHelper != null)
            {
                // Dispose JavaScript handlers
                await JSRuntime.InvokeVoidAsync("WorkspaceKeyboardHandler.dispose");
                await JSRuntime.InvokeVoidAsync("disposeWikiLinkPreview");

                if (selectedNote != null || creatingNote)
                {
                    var elementId = creatingNote ? "note-editor-new" : $"note-editor-{selectedNote?.Id}";
                    await JSRuntime.InvokeVoidAsync("WikiLinkEditor.dispose", elementId);
                }

                dotNetHelper.Dispose();
            }

            if (wikiLinkEditorModule != null)
            {
                await wikiLinkEditorModule.DisposeAsync();
            }

            if (imageUploadModule != null)
            {
                await imageUploadModule.DisposeAsync();
            }

            if (imageLightboxModule != null)
            {
                await imageLightboxModule.InvokeVoidAsync("disposeImageLightbox");
                await imageLightboxModule.DisposeAsync();
            }
        }
        catch
        {
            // Ignore disposal errors
        }
    }
}
