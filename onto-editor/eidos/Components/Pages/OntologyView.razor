@page "/ontology/{id:int}"
@using Eidos.Models
@using Eidos.Models.DTOs
@using Eidos.Models.Enums
@using Eidos.Models.Events
@using Eidos.Models.ViewState
@using Eidos.Services
@using Eidos.Services.Interfaces
@using Eidos.Components.Shared
@using Eidos.Components.Ontology
@using Eidos.Components.Ontology.Admin
@using VDS.RDF
@using Microsoft.JSInterop
@using static Eidos.Services.TtlExportService
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@implements IAsyncDisposable
@inject IOntologyService OntologyService
@inject IOntologyShareService ShareService
@inject IUserPreferencesService PreferencesService
@inject IConceptService ConceptService
@inject IConceptPropertyService ConceptPropertyService
@inject IIndividualService IndividualService
@inject IRestrictionService RestrictionService
@inject ITtlImportService TtlImportService
@inject ITtlExportService TtlExportService
@inject OntologyPermissionService PermissionService
@inject IMergeRequestService MergeRequestService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ConfirmService ConfirmService
@inject ToastService ToastService
@inject ILogger<OntologyView> Logger
@inject IOntologyValidationService ValidationService
@inject RecentItemsService RecentItemsService
@inject IOntologyViewHistoryService ViewHistoryService
@inject Data.Repositories.NoteRepository NoteRepository
@inject WorkspaceService WorkspaceService
@rendermode InteractiveServer

<PageTitle>@(ontology?.Name ?? "Ontology")</PageTitle>

@if (loadError != null)
{
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle"></i> Error Loading Ontology
                        </h5>
                    </div>
                    <div class="card-body">
                        <p>@loadError</p>
                        <a href="/" class="btn btn-primary">
                            <i class="bi bi-house"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else if (ontology == null)
{
    <div class="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h4>Loading Ontology</h4>
            <p class="text-muted">Please wait...</p>
        </div>
    </div>
}
else
{
    <div class="container-fluid mt-2" tabindex="-1" @onkeydown="HandleKeyDown" @ref="mainContainer">
        <!-- Permission Level Banner -->
        <PermissionBanner UserPermissionLevel="@userPermissionLevel" />

        <!-- Keyboard Shortcuts Banner -->
        <KeyboardShortcutsBanner IsVisible="@showKeyboardShortcutsBanner"
                                OnDismissTemporarily="@DismissKeyboardShortcutsTemporarily"
                                OnDismissPermanently="@DismissKeyboardShortcutsPermanently" />

        <!-- Global Search Banner -->
        <GlobalSearchBanner IsVisible="@showGlobalSearchBanner"
                           OnDismissTemporarily="@DismissGlobalSearchBannerTemporarily"
                           OnDismissPermanently="@DismissGlobalSearchBannerPermanently" />

        <!-- Header -->
        <OntologyHeader Name="@ontology.Name"
                       Description="@ontology.Description"
                       Tags="@ontology.Tags"
                       Author="@ontology.Author"
                       Version="@ontology.Version"
                       ParentOntologyId="@ontology.ParentOntologyId"
                       ProvenanceType="@ontology.ProvenanceType"
                       ConceptCount="@ontology.Concepts.Count"
                       RelationshipCount="@ontology.Relationships.Count"
                       OnBackClick="@GoBack"
                       OnSearchClick="@HandleGlobalSearch" />

        <!-- TTL Import Dialog -->
        <TtlImportDialog IsVisible="@showImportDialog"
                        CurrentStep="@importStep"
                        IsProcessing="@isProcessingFile"
                        IsImporting="@isImporting"
                        ErrorMessage="@importError"
                        ImportResult="@importResult"
                        MergePreview="@mergePreview"
                        SelectedOption="@importOption"
                        SelectedOptionChanged="@((value) => importOption = value)"
                        OntologyName="@ontology.Name"
                        OnFileSelected="@HandleFileSelected"
                        OnCancelClick="@CancelImport"
                        OnExecuteImport="@ExecuteImport" />

        <!-- Export Dialog -->
        <ExportDialog @ref="exportDialog" Ontology="@ontology" />

        <!-- Share Modal -->
        <ShareModal Show="@showShareModal"
                    ShowChanged="@((bool show) => showShareModal = show)"
                    OntologyId="@ontology.Id"
                    OntologyName="@ontology.Name"
                    UserId="@ontology.UserId" />

        <!-- Lineage Modal -->
        <OntologyLineage @ref="lineageComponent" ontology="@ontology" />

        <!-- Fork/Clone Dialog -->
        <ForkCloneDialog @ref="forkCloneDialog" />

        <!-- Link Ontology Dialog -->
        <LinkOntologyDialog @ref="linkOntologyDialog"
                           CurrentOntologyId="@Id"
                           OnOntologyLinked="@HandleOntologyLinked" />

        <!-- Bulk Create Dialog -->
        @if (showBulkCreate)
        {
            <BulkCreateDialog OntologyId="@Id"
                             ExistingConcepts="@ontology.Concepts.ToList()"
                             ExistingRelationships="@ontology.Relationships.ToList()"
                             OnClose="@(() => showBulkCreate = false)"
                             OnItemsCreated="@OnBulkCreateComplete" />
        }

        <!-- Admin Concept Dialog -->
        <AdminConceptDialog @ref="adminConceptDialog"
                           OntologyId="@Id"
                           CurrentUserId="@currentUserId"
                           OnChanged="@HandleAdminDialogChanged" />

        <!-- Merge Request Dialog -->
        <MergeRequestDialog @ref="mergeRequestDialog"
                           OntologyId="@Id"
                           CurrentUserId="@currentUserId"
                           OnMergeRequestCreated="@HandleMergeRequestCreated" />

        <!-- Approval Workflow Banner (for contributors) -->
        @if (ontology != null && ontology.RequiresApproval && !CanFullAccess())
        {
            <div class="alert alert-info d-flex justify-content-between align-items-center mb-2" role="alert">
                <div>
                    <i class="bi bi-info-circle-fill me-2"></i>
                    <strong>Approval Required:</strong> This ontology requires merge requests for changes.
                    Make your changes, then create a merge request to submit them for review.
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" @onclick="@(() => viewMode = ViewMode.VersionHistory)">
                        <i class="bi bi-clock-history"></i> View My Changes
                    </button>
                    <button class="btn btn-sm btn-primary" @onclick="@ShowMergeRequestDialog">
                        <i class="bi bi-git"></i> Create Merge Request
                    </button>
                </div>
            </div>
        }

        <!-- Ontology Control Bar -->
        <OntologyControlBar CanFullAccess="@CanFullAccess()"
                           CanEdit="@CanEdit()"
                           CanAdd="@CanAdd()"
                           PresenceUsers="@presenceUsers"
                           CurrentViewMode="@viewMode"
                           OnLineageClick="@ShowLineageDialog"
                           OnForkClick="@ShowForkDialogFromHeader"
                           OnCloneClick="@ShowCloneDialogFromHeader"
                           OnShareClick="@ShowShareModalFromHeader"
                           OnSettingsClick="@ShowSettingsDialog"
                           OnImportClick="@ShowImportDialog"
                           OnExportClick="@ShowExportDialog"
                           OnNotesClick="@NavigateToWorkspaceNotes"
                           OnAddConceptClick="@ShowAddConceptDialog"
                           OnAddRelationshipClick="@ShowAddRelationshipDialog"
                           OnBulkCreateClick="@ShowBulkCreateDialog"
                           OnLinkOntologyClick="@ShowLinkOntologyDialog"
                           OnManageConceptsClick="@ShowAdminConceptDialog"
                           OnViewModeChanged="@SwitchViewMode"
                           OnUndoClick="@HandleUndo"
                           OnRedoClick="@HandleRedo"
                           CanUndo="@OntologyService.CanUndo()"
                           CanRedo="@OntologyService.CanRedo()"
                           OnNavigateToUserView="@NavigateToUserView"
                           PendingMergeRequestCount="@pendingMergeRequestCount"
                           OnViewMergeRequestsClick="@HandleViewMergeRequests" />

        <!-- Main Content Layout Wrapper (Desktop: side-by-side, Mobile: stacked) -->
        <div class="ontology-main-layout">
            <div class="ontology-tabs-container">
            <!-- Tab Content Area -->
            <div class="ontology-tab-content">
                @if (viewMode == ViewMode.Graph)
                {
                    <GraphViewContainer ViewState="@viewState"
                                       GraphState="@graphState"
                                       OnAddConceptClick="@GetConditionalCallback(CanAdd(), ShowAddConceptDialog)"
                                       OnAddRelationshipClick="@GetConditionalCallback(CanAdd(), ShowAddRelationshipDialog)"
                                       OnNodeClick="@HandleNodeClick"
                                       OnNodeEditClick="@HandleNodeEditClick"
                                       OnNodeCtrlClick="@GetConditionalCallback(CanAdd(), HandleNodeCtrlClick)"
                                       OnEdgeClick="@HandleEdgeClick"
                                       OnIndividualClick="@HandleIndividualClick"
                                       OnOntologyLinkClick="@HandleOntologyLinkClick"
                                       OnVirtualConceptClick="@HandleVirtualConceptClick"
                                       OnVirtualConceptCtrlClick="@(async (data) => { if (CanAdd()) await HandleVirtualConceptCtrlClick(data); })"
                                       OnViewModeChanged="@SwitchViewMode"
                                       OnUndoClick="@HandleUndo"
                                       OnRedoClick="@HandleRedo"
                                       CanUndo="@OntologyService.CanUndo()"
                                       CanRedo="@OntologyService.CanRedo()"
                                       CanAdd="@CanAdd()"
                                       @ref="graphViewContainer" />
                }
                else if (viewMode == ViewMode.List)
                {
                    <ListViewPanel @key="@($"listview-{ontology.Id}-{ontology.UpdatedAt.Ticks}")"
                                   Concepts="@ontology.Concepts"
                                   Relationships="@ontology.Relationships"
                                   LinkedOntologies="@ontology.LinkedOntologies"
                                   ValidationResult="@validationResult"
                                   OntologyId="@ontology.Id"
                                   SortOption="@sortOption"
                                   SortOptionChanged="@((value) => sortOption = value)"
                                   @bind-ActiveListTab="@activeListTab"
                                   OnAddConceptClick="@GetConditionalCallback(CanAdd(), ShowAddConceptDialog)"
                                   OnAddRelationshipClick="@GetConditionalCallback(CanAdd(), ShowAddRelationshipDialog)"
                                   OnConceptSelect="@SelectConcept"
                                   OnConceptEdit="@GetConditionalCallback(CanEdit(), EditConcept)"
                                   OnConceptDuplicate="@DuplicateConcept"
                                   OnConceptDelete="@GetConditionalCallback(CanEdit(), DeleteConcept)"
                                   OnRelationshipEdit="@GetConditionalCallback(CanEdit(), EditRelationship)"
                                   OnRelationshipDuplicate="@DuplicateRelationship"
                                   OnRelationshipDelete="@GetConditionalCallback(CanEdit(), DeleteRelationship)"
                                   OnVirtualConceptImport="@HandleVirtualConceptImportFromList"
                                   OnConceptNameUpdate="@HandleConceptNameUpdate"
                                   CanEdit="@CanEdit" />
                }
                else if (viewMode == ViewMode.Hierarchy)
                {
                    <HierarchyView HierarchyNodes="@hierarchyNodes"
                                  SelectedConceptId="@selectedConceptId"
                                  OnConceptSelected="@SelectConcept" />
                }
                else if (viewMode == ViewMode.MindMap)
                {
                    <MindMapView Ontology="@ontology"
                                Height="calc(100vh - 180px)"
                                CanAdd="@CanAdd()"
                                OnConceptClick="@HandleMindMapConceptClick"
                                OnAddConceptClick="@GetConditionalCallback(CanAdd(), ShowAddConceptDialog)" />
                }
                else if (viewMode == ViewMode.Instances)
                {
                    <InstancesView Individuals="@individuals"
                                  SelectedIndividual="@selectedIndividual"
                                  OnIndividualSelected="@SelectIndividual"
                                  OnAddIndividualClick="@GetConditionalCallback(CanAdd(), () => ShowAddIndividualDialog())"
                                  OnEditIndividualClick="@(async (ind) => { if (CanEdit()) EditIndividual(ind); await Task.CompletedTask; })"
                                  OnDeleteIndividualClick="@(async (ind) => { if (CanEdit()) await DeleteIndividual(ind); })"
                                  CanEdit="@CanEdit()" />
                }
                else if (viewMode == ViewMode.Ttl)
                {
                    <TtlViewPanel Ontology="@ontology" />
                }
                else if (viewMode == ViewMode.Notes)
                {
                    <NotesView Notes="@editingNotes"
                              NotesChanged="@((value) => editingNotes = value)"
                              OnSaveClick="@GetConditionalCallback(CanEdit(), SaveNotes)"
                              CanEdit="@CanEdit()" />
                }
                else if (viewMode == ViewMode.Templates)
                {
                    <TemplateManager Templates="@ontology.CustomTemplates"
                                    OnTemplateAdded="@GetConditionalCallback(CanEdit(), SaveCustomTemplate)"
                                    OnTemplateUpdated="@GetConditionalCallback(CanEdit(), UpdateCustomTemplate)"
                                    OnTemplateDeleted="@GetConditionalCallback(CanEdit(), DeleteCustomTemplate)"
                                    CanEdit="@CanEdit()" />
                }
                else if (viewMode == ViewMode.Links)
                {
                    <LinkedOntologiesManager LinkedOntologies="@ontology.LinkedOntologies" />
                }
                else if (viewMode == ViewMode.Collaborators)
                {
                    <CollaboratorPanel OntologyId="@ontology.Id"
                                      ShowDetails="true"
                                      ShowActivity="true"
                                      RecentActivityLimit="10" />
                }
                else if (viewMode == ViewMode.VersionHistory)
                {
                    <VersionHistoryPanel OntologyId="@ontology.Id"
                                        CurrentUserId="@currentUserId"
                                        OnRevertRequested="@HandleRevertRequested" />
                }
                else if (viewMode == ViewMode.MergeRequests)
                {
                    <div class="card">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="bi bi-git"></i> Merge Requests</h5>
                        </div>
                        <div class="card-body">
                            <MergeRequestListPanel @ref="mergeRequestListPanel"
                                                  OntologyId="@Id"
                                                  CurrentUserId="@currentUserId" />
                        </div>
                    </div>
                }
                else if (viewMode == ViewMode.Help)
                {
                    <OntologyFrameworkGuide />
                }
            </div>
            </div>

            <!-- Details Panel Sidebar (Right Side) - Hidden on Graph page -->
            @if (viewMode != ViewMode.Graph)
            {
                <div class="ontology-details-sidebar">
                    <!-- Recent Items Section -->
                    @if (recentItems != null && recentItems.Any())
                    {
                        <div class="mb-3">
                            <RecentItemsPanel RecentItems="@recentItems"
                                             OnItemSelected="@HandleRecentItemSelected"
                                             OnClearRecent="@HandleClearRecentItems" />
                        </div>
                    }

                    <!-- Merge Requests Section -->
                    @if (ontology.RequiresApproval || hasPendingMergeRequests)
                    {
                        <div class="mb-3">
                            <MergeRequestListPanel @ref="mergeRequestListPanel"
                                                  OntologyId="@Id"
                                                  CurrentUserId="@currentUserId" />
                        </div>
                    }

                    <SelectedNodeDetailsPanel SelectedConcept="@selectedConcept"
                                             SelectedRelationship="@selectedRelationship"
                                             SelectedIndividual="@selectedIndividual"
                                             ConnectedConcepts="@GetConnectedConcepts()"
                                             ConceptProperties="@selectedConceptProperties"
                                             OnPropertiesChanged="@HandlePropertiesChanged"
                                             OntologyId="@Id" />
                </div>
            }
        </div> <!-- Close ontology-main-layout -->
    </div> <!-- Close container-fluid -->

    <!-- Floating Modal - Only on Graph page -->
        @if (viewMode == ViewMode.Graph && (showAddIndividual || selectedConcept != null || selectedRelationship != null || selectedIndividual != null))
        {
            <div class="ontology-floating-modal">
                <div class="ontology-floating-modal-backdrop" @onclick="CloseMobileEditor"></div>
                <div class="ontology-floating-modal-content">
                    <div class="ontology-floating-modal-header">
                        <h6 class="mb-0">
                            @if (showAddIndividual)
                            {
                                <span><i class="bi bi-person-plus me-2"></i>@(editingIndividual != null ? "Edit Individual" : "Add Individual")</span>
                            }
                            else if (selectedIndividual != null) { <span><i class="bi bi-person-fill me-2"></i>Individual Details</span> }
                            else if (selectedConcept != null) { <span><i class="bi bi-info-circle me-2"></i>Concept Details</span> }
                            else if (selectedRelationship != null) { <span><i class="bi bi-info-circle me-2"></i>Relationship Details</span> }
                        </h6>
                        <button type="button" class="btn-close" aria-label="Close" @onclick="CloseMobileEditor"></button>
                    </div>
                    <div class="ontology-floating-modal-body">
                        @if (showAddIndividual)
                        {
                            <IndividualEditor IsEditing="@(editingIndividual != null)"
                                             Concepts="@ontology.Concepts"
                                             @bind-ConceptId="@newIndividual.ConceptId"
                                             @bind-IndividualName="@newIndividual.Name"
                                             @bind-IndividualDescription="@newIndividual.Description"
                                             @bind-IndividualLabel="@newIndividual.Label"
                                             @bind-IndividualUri="@newIndividual.Uri"
                                             @bind-Properties="@newIndividualProperties"
                                             OnSaveClick="@SaveIndividual"
                                             OnCancelClick="@CancelIndividualDialog" />
                        }
                        else if (selectedIndividual != null)
                        {
                            var individualConceptMobile = selectedIndividual.Concept ?? ontology?.Concepts.FirstOrDefault(c => c.Id == selectedIndividual.ConceptId);

                            <div class="card border-0 shadow-none">
                                <div class="card-body">
                                    <div class="d-flex align-items-center gap-2 mb-3">
                                        <i class="bi bi-person-fill fs-4" style="color: @(individualConceptMobile?.Color ?? "#4A90E2");"></i>
                                        <h5 class="mb-0">@selectedIndividual.Name</h5>
                                    </div>

                                    @if (individualConceptMobile != null)
                                    {
                                        <p class="mb-2">
                                            <strong>Instance of:</strong>
                                            <span class="badge" style="background-color: @(individualConceptMobile.Color ?? "#4A90E2");">
                                                @individualConceptMobile.Name
                                            </span>
                                        </p>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(selectedIndividual.Label))
                                    {
                                        <p class="mb-2"><strong>Label:</strong> @selectedIndividual.Label</p>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(selectedIndividual.Description))
                                    {
                                        <p class="mb-2"><strong>Description:</strong> @selectedIndividual.Description</p>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(selectedIndividual.Uri))
                                    {
                                        <p class="mb-2">
                                            <strong>URI:</strong><br/>
                                            <code class="small">@selectedIndividual.Uri</code>
                                        </p>
                                    }

                                    @if (selectedIndividual.Properties?.Any() == true)
                                    {
                                        <hr class="my-3" />
                                        <div class="mb-3">
                                            <h6 class="mb-2"><i class="bi bi-tags me-1"></i>Properties</h6>
                                            <div class="list-group list-group-flush">
                                                @foreach (var prop in selectedIndividual.Properties)
                                                {
                                                    <div class="list-group-item px-0 py-2">
                                                        <strong>@prop.Name:</strong> @prop.Value
                                                        @if (!string.IsNullOrWhiteSpace(prop.DataType))
                                                        {
                                                            <br/><small class="text-muted">Type: @prop.DataType</small>
                                                        }
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }

                                    <hr class="my-3" />

                                    @if (CanEdit())
                                    {
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-outline-primary btn-sm" @onclick="() => EditIndividual(selectedIndividual)">
                                                <i class="bi bi-pencil me-2"></i>Edit Individual
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" @onclick="async () => await DeleteIndividual(selectedIndividual)">
                                                <i class="bi bi-trash me-2"></i>Delete Individual
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else if (selectedConcept != null)
                        {
                            <div class="card border-0 shadow-none">
                                <div class="card-body">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <div style="width: 30px; height: 30px; background-color: @selectedConcept.Color; border-radius: 4px;"></div>
                                        <h5 class="mb-0 flex-grow-1">@selectedConcept.Name</h5>
                                    </div>

                                    @* Open Note Button - Prominent placement *@
                                    <div class="mb-3">
                                        <button class="btn btn-sm btn-primary w-100" @onclick="() => ViewConceptNoteFromModal(selectedConcept)">
                                            <i class="bi bi-journal-text me-1"></i>
                                            Open Note
                                        </button>
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(selectedConcept.Category))
                                    {
                                        <p class="mb-2"><strong>Category:</strong> @selectedConcept.Category</p>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(selectedConcept.SimpleExplanation))
                                    {
                                        <p class="mb-2"><strong>Explanation:</strong> @selectedConcept.SimpleExplanation</p>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(selectedConcept.Definition))
                                    {
                                        <p class="mb-2"><strong>Definition:</strong> @selectedConcept.Definition</p>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(selectedConcept.Examples))
                                    {
                                        <p class="mb-2">
                                            <strong>Examples:</strong><br/>
                                            <em>@selectedConcept.Examples</em>
                                        </p>
                                    }

                                    @* Connected Concepts Section *@
                                    @{
                                        var connectedConceptsMobile = GetConnectedConcepts(selectedConcept.Id);
                                        if (connectedConceptsMobile.Any())
                                        {
                                            <hr class="my-3" />
                                            <div class="mb-3">
                                                <h6 class="mb-2"><i class="bi bi-diagram-3 me-1"></i>Connected Concepts</h6>
                                                <div class="list-group list-group-flush">
                                                    @foreach (var connection in connectedConceptsMobile)
                                                    {
                                                        <div class="list-group-item px-0 py-2">
                                                            <div class="d-flex align-items-center gap-2">
                                                                <div style="width: 20px; height: 20px; background-color: @connection.ConceptColor; border-radius: 3px;"></div>
                                                                <div class="flex-grow-1">
                                                                    <strong>@connection.ConceptName</strong>
                                                                    <br/>
                                                                    <small class="text-muted">
                                                                        @if (connection.IsOutgoing)
                                                                        {
                                                                            <span>@selectedConcept.Name <i class="bi bi-arrow-right mx-1"></i> @connection.ConceptName</span>
                                                                        }
                                                                        else
                                                                        {
                                                                            <span>@connection.ConceptName <i class="bi bi-arrow-right mx-1"></i> @selectedConcept.Name</span>
                                                                        }
                                                                        <br/>
                                                                        <span class="badge bg-secondary">@connection.RelationType</span>
                                                                    </small>
                                                                </div>
                                                                <button class="btn btn-sm btn-outline-primary"
                                                                        @onclick="() => SelectConcept(ontology!.Concepts.First(c => c.Id == connection.ConceptId))"
                                                                        title="View this concept">
                                                                    <i class="bi bi-eye"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    }

                                    @* Property Definitions Section *@
                                    <hr class="my-3" />
                                    <div class="mb-3">
                                        <ConceptPropertyEditor ConceptId="@selectedConcept.Id"
                                                              Properties="@(selectedConceptProperties ?? new List<ConceptProperty>())"
                                                              PropertiesChanged="@HandlePropertiesChanged" />
                                    </div>

                                    <hr class="my-3" />

                                    <ConceptRestrictionsEditor Restrictions="@selectedConceptRestrictions"
                                                              OnAddRestrictionClick="@(() => ShowAddRestrictionDialog())"
                                                              OnEditRestrictionClick="@((r) => EditRestriction(r))"
                                                              OnDeleteRestrictionClick="@((r) => DeleteRestriction(r))"
                                                              CanEdit="@CanEdit()" />
                                </div>
                            </div>
                        }
                        else if (selectedRelationship != null)
                        {
                            <div class="card border-0 shadow-none">
                                <div class="card-body">
                                    <h5 class="mb-3">@selectedRelationship.RelationType</h5>

                                    @{
                                        var sourceConcept = ontology?.Concepts.FirstOrDefault(c => c.Id == selectedRelationship.SourceConceptId);
                                        var targetConcept = ontology?.Concepts.FirstOrDefault(c => c.Id == selectedRelationship.TargetConceptId);
                                    }

                                    <div class="mb-3">
                                        <p class="mb-2"><strong>Source Concept:</strong></p>
                                        @if (sourceConcept != null)
                                        {
                                            <div class="d-flex align-items-center gap-2 ms-3">
                                                <div style="width: 20px; height: 20px; background-color: @sourceConcept.Color; border-radius: 3px;"></div>
                                                <span>@sourceConcept.Name</span>
                                            </div>
                                        }
                                    </div>

                                    <div class="mb-3">
                                        <p class="mb-2"><strong>Target Concept:</strong></p>
                                        @if (targetConcept != null)
                                        {
                                            <div class="d-flex align-items-center gap-2 ms-3">
                                                <div style="width: 20px; height: 20px; background-color: @targetConcept.Color; border-radius: 3px;"></div>
                                                <span>@targetConcept.Name</span>
                                            </div>
                                        }
                                    </div>

                                    @if (!string.IsNullOrWhiteSpace(selectedRelationship.Label))
                                    {
                                        <p class="mb-2"><strong>Label:</strong> @selectedRelationship.Label</p>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(selectedRelationship.Description))
                                    {
                                        <p class="mb-2">
                                            <strong>Description:</strong><br/>
                                            @selectedRelationship.Description
                                        </p>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <!-- Floating Panels for Add/Edit Concept and Relationship -->
        @if (showAddConcept)
        {
            <AddConceptFloatingPanel @ref="addConceptFloatingPanel"
                                     IsVisible="@showAddConcept"
                                     OnClose="@CancelConceptDialog"
                                     IsEditing="@(editingConcept != null)"
                                     ShouldPulse="@shouldPulseSidebar"
                                     CustomTemplates="@ontology.CustomTemplates"
                                     ConceptName="@newConcept.Name"
                                     ConceptNameChanged="@((value) => newConcept.Name = value)"
                                     ConceptCategory="@newConcept.Category"
                                     ConceptCategoryChanged="@OnConceptCategoryChanged"
                                     ConceptExplanation="@newConcept.SimpleExplanation"
                                     ConceptExplanationChanged="@((value) => newConcept.SimpleExplanation = value)"
                                     ConceptExamples="@newConcept.Examples"
                                     ConceptExamplesChanged="@((value) => newConcept.Examples = value)"
                                     ConceptColor="@newConcept.Color"
                                     ConceptColorChanged="@OnConceptColorChanged"
                                     OnSaveClick="@SaveConcept"
                                     OnSaveAndAddAnotherClick="@SaveConceptAndAddAnother"
                                     OnCancelClick="@CancelConceptDialog"
                                     OnTemplateSelected="@ApplyConceptTemplate" />
        }

        @if (showAddRelationship)
        {
            <AddRelationshipFloatingPanel IsVisible="@showAddRelationship"
                                          OnClose="@CancelRelationshipDialog"
                                          IsEditing="@(editingRelationship != null)"
                                          ShouldPulse="@shouldPulseSidebar"
                                          Concepts="@ontology.Concepts"
                                          ExistingRelationshipTypes="@GetExistingRelationshipTypes()"
                                          SourceConceptId="@newRelationship.SourceConceptId"
                                          SourceConceptIdChanged="@((value) => newRelationship.SourceConceptId = value)"
                                          TargetConceptId="@newRelationship.TargetConceptId"
                                          TargetConceptIdChanged="@((value) => newRelationship.TargetConceptId = value)"
                                          RelationType="@newRelationship.RelationType"
                                          RelationTypeChanged="@((value) => newRelationship.RelationType = value)"
                                          CustomType="@customRelationType"
                                          CustomTypeChanged="@((value) => customRelationType = value)"
                                          Label="@newRelationship.Label"
                                          LabelChanged="@((value) => newRelationship.Label = value)"
                                          Description="@newRelationship.Description"
                                          DescriptionChanged="@((value) => newRelationship.Description = value)"
                                          OnSaveClick="@SaveRelationship"
                                          OnCancelClick="@CancelRelationshipDialog" />
        }

    <!-- Global Search -->
    <CascadingValue Name="Ontology" Value="@ontology">
        <GlobalSearch @ref="globalSearch"
                     Notes="@workspaceNotes"
                     OnResultSelected="@HandleSearchResultSelected"
                     OnActionExecuted="@HandleActionExecuted"
                     OnHide="@RestoreFocusAfterSearch" />
    </CascadingValue>

    <!-- What's New Panel (positioned fixed) -->
    <WhatsNewPanel WhatsNew="@whatsNew" OnDismiss="@HandleWhatsNewDismiss" StartExpanded="true" />
}

