@page "/admin"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using Eidos.Data
@using Eidos.Models
@using Microsoft.Extensions.Diagnostics.HealthChecks
@using Microsoft.JSInterop
@using System.Runtime.InteropServices
@attribute [Authorize(Policy = AppPolicies.RequireAdmin)]
@inject OntologyDbContext DbContext
@inject IConfiguration Configuration
@inject HealthCheckService HealthCheckService
@inject ILogger<Admin> Logger
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Admin Dashboard - Eidos</PageTitle>

<div class="admin-dashboard">
    <div class="admin-header">
        <div class="admin-header-content">
            <div class="admin-header-left">
                <i class="bi bi-sliders"></i>
                <div>
                    <h1>Admin Dashboard</h1>
                    <p class="text-muted mb-0">System monitoring and management</p>
                </div>
            </div>
            <div class="admin-header-right">
                <button class="btn btn-outline-primary btn-sm" @onclick="RefreshAllData">
                    <i class="bi bi-arrow-clockwise"></i> Refresh All
                </button>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-state">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading dashboard data...</p>
        </div>
    }
    else
    {
        <div class="admin-content">
            <!-- System Health Overview -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2><i class="bi bi-heart-pulse"></i> System Health</h2>
                    <span class="badge bg-@GetHealthBadgeClass()">@healthStatus</span>
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="stat-card @(databaseHealthy ? "stat-card-success" : "stat-card-danger")">
                            <div class="stat-icon">
                                <i class="bi bi-database"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Database</div>
                                <div class="stat-value">@(databaseHealthy ? "Healthy" : "Unhealthy")</div>
                                <div class="stat-meta">@dbResponseTime ms</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card stat-card-info">
                            <div class="stat-icon">
                                <i class="bi bi-server"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Environment</div>
                                <div class="stat-value">@environment</div>
                                <div class="stat-meta">@RuntimeInformation.OSDescription</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card stat-card-warning">
                            <div class="stat-icon">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Uptime</div>
                                <div class="stat-value">@FormatUptime()</div>
                                <div class="stat-meta">Since @startupTime.ToString("MMM dd, HH:mm")</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card stat-card-primary">
                            <div class="stat-icon">
                                <i class="bi bi-memory"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-label">Memory</div>
                                <div class="stat-value">@GetMemoryUsage() MB</div>
                                <div class="stat-meta">Working set</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Analytics -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2><i class="bi bi-database-fill-gear"></i> Database Analytics</h2>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="RefreshDatabaseStats">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="info-card">
                            <div class="info-card-header">
                                <i class="bi bi-diagram-3"></i>
                                <h3>Ontologies</h3>
                            </div>
                            <div class="info-card-body">
                                <div class="metric">
                                    <span class="metric-value">@ontologyCount</span>
                                    <span class="metric-label">Total ontologies</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">@conceptCount</span>
                                    <span class="metric-label">Total concepts</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-card">
                            <div class="info-card-header">
                                <i class="bi bi-people"></i>
                                <h3>Users</h3>
                            </div>
                            <div class="info-card-body">
                                <div class="metric">
                                    <span class="metric-value">@userCount</span>
                                    <span class="metric-label">Total users</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">@recentUserCount</span>
                                    <span class="metric-label">Active (7 days)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="info-card">
                            <div class="info-card-header">
                                <i class="bi bi-activity"></i>
                                <h3>Activity</h3>
                            </div>
                            <div class="info-card-body">
                                <div class="metric">
                                    <span class="metric-value">@activityCount</span>
                                    <span class="metric-label">Recent actions (24h)</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">@versionCount</span>
                                    <span class="metric-label">Total versions</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Workspaces & Notes Analytics -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2><i class="bi bi-journal-text"></i> Workspaces & Notes</h2>
                    <button class="btn btn-sm btn-outline-secondary" @onclick="RefreshDatabaseStats">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="info-card">
                            <div class="info-card-header">
                                <i class="bi bi-folder"></i>
                                <h3>Workspaces</h3>
                            </div>
                            <div class="info-card-body">
                                <div class="metric">
                                    <span class="metric-value">@workspaceCount</span>
                                    <span class="metric-label">Total workspaces</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">@publicWorkspaceCount</span>
                                    <span class="metric-label">Public workspaces</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-card">
                            <div class="info-card-header">
                                <i class="bi bi-file-text"></i>
                                <h3>Notes</h3>
                            </div>
                            <div class="info-card-body">
                                <div class="metric">
                                    <span class="metric-value">@totalNotesCount</span>
                                    <span class="metric-label">Total notes</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">@conceptNotesCount</span>
                                    <span class="metric-label">Concept notes</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-card">
                            <div class="info-card-header">
                                <i class="bi bi-tags"></i>
                                <h3>Organization</h3>
                            </div>
                            <div class="info-card-body">
                                <div class="metric">
                                    <span class="metric-value">@tagCount</span>
                                    <span class="metric-label">Total tags</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">@tagAssignmentCount</span>
                                    <span class="metric-label">Tag assignments</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="info-card">
                            <div class="info-card-header">
                                <i class="bi bi-pie-chart"></i>
                                <h3>Storage</h3>
                            </div>
                            <div class="info-card-body">
                                <div class="metric">
                                    <span class="metric-value">@FormatStorageSize(totalContentSize)</span>
                                    <span class="metric-label">Total content</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-value">@avgNoteSize KB</span>
                                    <span class="metric-label">Avg note size</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Info -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2><i class="bi bi-gear"></i> Configuration</h2>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="config-panel">
                            <h3><i class="bi bi-windows"></i> Server Configuration</h3>
                            <div class="config-list">
                                <div class="config-item">
                                    <span class="config-key">Platform</span>
                                    <span class="config-value">IIS / Windows Server</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-key">Runtime</span>
                                    <span class="config-value">.NET 9.0</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-key">Hosting Model</span>
                                    <span class="config-value">In-Process</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-key">Database</span>
                                    <span class="config-value">SQL Server (Local/Remote)</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-key">OS</span>
                                    <span class="config-value">@RuntimeInformation.OSDescription</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-key">Architecture</span>
                                    <span class="config-value">@RuntimeInformation.ProcessArchitecture.ToString()</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="config-panel">
                            <h3><i class="bi bi-key"></i> Authentication</h3>
                            <div class="config-list">
                                <div class="config-item">
                                    <span class="config-key">GitHub OAuth</span>
                                    <span class="config-value"><i class="bi bi-check-circle text-success"></i>
                                        Configured</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-key">Google OAuth</span>
                                    <span class="config-value"><i class="bi bi-check-circle text-success"></i>
                                        Configured</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-key">Microsoft OAuth</span>
                                    <span class="config-value"><i class="bi bi-check-circle text-success"></i>
                                        Configured</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-key">Identity Framework</span>
                                    <span class="config-value">ASP.NET Core Identity</span>
                                </div>
                                <div class="config-item">
                                    <span class="config-key">Connection Security</span>
                                    <span class="config-value">SQL Server Authentication</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-section">
                <div class="section-header">
                    <h2><i class="bi bi-lightning"></i> Quick Actions</h2>
                </div>
                <div class="quick-actions">
                    <div class="action-group">
                        <h3>IIS Management</h3>
                        <div class="action-buttons">
                            <button class="btn btn-outline-warning"
                                @onclick="@(() => ShowCommandInfo("Restart App Pool", "iisreset /restart or Restart-WebAppPool -Name 'EidosAppPool'"))">
                                <i class="bi bi-arrow-clockwise"></i> Restart App
                            </button>
                            <button class="btn btn-outline-info"
                                @onclick="@(() => ShowCommandInfo("View IIS Logs", "Get-Content 'C:\\inetpub\\logs\\LogFiles\\W3SVC1\\*.log' -Tail 50"))">
                                <i class="bi bi-file-text"></i> View Logs
                            </button>
                            <button class="btn btn-outline-secondary"
                                @onclick="@(() => ShowCommandInfo("Check App Pool Status", "Get-WebAppPoolState -Name 'EidosAppPool'"))">
                                <i class="bi bi-info-circle"></i> App Status
                            </button>
                        </div>
                    </div>
                    <div class="action-group">
                        <h3>Database</h3>
                        <div class="action-buttons">
                            <button class="btn btn-outline-primary"
                                @onclick="@(() => ShowCommandInfo("Database Size", "sqlcmd -S localhost -Q \"SELECT DB_NAME(database_id) AS DB, (SUM(size) * 8) / 1024 AS 'Size (MB)' FROM sys.master_files GROUP BY database_id\""))">
                                <i class="bi bi-database"></i> DB Size
                            </button>
                            <button class="btn btn-outline-success"
                                @onclick="@(() => ShowCommandInfo("Database Backup", "sqlcmd -Q \"BACKUP DATABASE [EidosDb] TO DISK='C:\\Backups\\EidosDb.bak'\""))">
                                <i class="bi bi-shield-check"></i> Backup DB
                            </button>
                            <button class="btn btn-outline-warning"
                                @onclick="@(() => ShowCommandInfo("Check DB Connection", "Test-NetConnection -ComputerName localhost -Port 1433"))">
                                <i class="bi bi-plug"></i> Test Connection
                            </button>
                        </div>
                    </div>
                    <div class="action-group">
                        <h3>Monitoring</h3>
                        <div class="action-buttons">
                            <button class="btn btn-outline-info"
                                @onclick="@(() => ShowCommandInfo("Application Logs", "Get-EventLog -LogName Application -Source 'ASP.NET*' -Newest 50"))">
                                <i class="bi bi-graph-up-arrow"></i> Event Logs
                            </button>
                            <button class="btn btn-outline-danger"
                                @onclick="@(() => ShowCommandInfo("Recent Errors", "Get-EventLog -LogName Application -EntryType Error -Newest 20"))">
                                <i class="bi bi-exclamation-triangle"></i> Errors
                            </button>
                            <button class="btn btn-outline-secondary"
                                @onclick="@(() => ShowCommandInfo("System Performance", "Get-Counter '\\Processor(_Total)\\% Processor Time','\\Memory\\Available MBytes'"))">
                                <i class="bi bi-speedometer2"></i> Performance
                            </button>
                        </div>
                    </div>
                    <div class="action-group">
                        <h3>Administration</h3>
                        <div class="action-buttons">
                            <a href="/admin/users" class="btn btn-outline-primary">
                                <i class="bi bi-people"></i> User Management
                            </a>
                            <a href="/admin" class="btn btn-outline-secondary">
                                <i class="bi bi-sliders"></i> Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Command Info Modal -->
            @if (showCommandModal)
            {
                <div class="modal-backdrop show" @onclick="CloseCommandModal"></div>
                <div class="modal show d-block" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-terminal"></i> @commandTitle
                                </h5>
                                <button type="button" class="btn-close" @onclick="CloseCommandModal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Run this command in your terminal or Azure Cloud Shell:
                                </div>
                                <div class="command-box">
                                    <code>@commandText</code>
                                    <button class="btn btn-sm btn-outline-primary copy-btn" @onclick="CopyCommand">
                                        <i class="bi bi-clipboard"></i> Copy
                                    </button>
                                </div>
                                @if (commandCopied)
                                {
                                    <div class="alert alert-success mt-3">
                                        <i class="bi bi-check-circle"></i> Command copied to clipboard!
                                    </div>
                                }
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn" @onclick="CloseCommandModal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code
{
    private bool isLoading = true;
    private string healthStatus = "Loading...";
    private bool databaseHealthy = false;
    private long dbResponseTime = 0;
    private string environment = "";
    private DateTime startupTime = DateTime.UtcNow;

    private int ontologyCount = 0;
    private int conceptCount = 0;
    private int userCount = 0;
    private int recentUserCount = 0;
    private int activityCount = 0;
    private int versionCount = 0;

    // Workspaces & Notes metrics
    private int workspaceCount = 0;
    private int publicWorkspaceCount = 0;
    private int totalNotesCount = 0;
    private int conceptNotesCount = 0;
    private int tagCount = 0;
    private int tagAssignmentCount = 0;
    private long totalContentSize = 0;
    private int avgNoteSize = 0;

    private bool showCommandModal = false;
    private string commandTitle = "";
    private string commandText = "";
    private bool commandCopied = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Get environment
            environment = Environment.GetEnvironmentVariable("ASPNETCORE_ENVIRONMENT") ?? "Production";

            // Check database health
            var sw = System.Diagnostics.Stopwatch.StartNew();
            try
            {
                await DbContext.Database.CanConnectAsync();
                databaseHealthy = true;
                sw.Stop();
                dbResponseTime = sw.ElapsedMilliseconds;
            }
            catch
            {
                databaseHealthy = false;
                dbResponseTime = -1;
            }

            // Load database statistics
            await RefreshDatabaseStats();

            // Set overall health status
            healthStatus = databaseHealthy ? "Healthy" : "Degraded";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dashboard data");
            healthStatus = "Error";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshDatabaseStats()
    {
        try
        {
            ontologyCount = await DbContext.Ontologies.CountAsync();
            conceptCount = await DbContext.Concepts.CountAsync();
            userCount = await DbContext.Users.CountAsync();

            var sevenDaysAgo = DateTime.UtcNow.AddDays(-7);
            recentUserCount = await DbContext.Users
            .Where(u => u.LastLoginAt.HasValue && u.LastLoginAt >= sevenDaysAgo)
            .CountAsync();

            var oneDayAgo = DateTime.UtcNow.AddDays(-1);
            activityCount = await DbContext.OntologyActivities
            .Where(a => a.CreatedAt >= oneDayAgo)
            .CountAsync();

            versionCount = await DbContext.OntologyActivities
            .Where(a => a.VersionNumber.HasValue)
            .Select(a => a.VersionNumber)
            .Distinct()
            .CountAsync();

            // Workspaces & Notes metrics
            workspaceCount = await DbContext.Workspaces.CountAsync();
            publicWorkspaceCount = await DbContext.Workspaces
                .Where(w => w.Visibility == "public")
                .CountAsync();

            totalNotesCount = await DbContext.Notes.CountAsync();
            conceptNotesCount = await DbContext.Notes
                .Where(n => n.IsConceptNote)
                .CountAsync();

            tagCount = await DbContext.Tags.CountAsync();
            tagAssignmentCount = await DbContext.NoteTagAssignments.CountAsync();

            // Calculate storage size (sum of content lengths)
            var contentSizes = await DbContext.NoteContents
                .Select(nc => nc.MarkdownContent != null ? nc.MarkdownContent.Length : 0)
                .ToListAsync();
            totalContentSize = contentSizes.Sum(s => (long)s);

            // Calculate average note size in KB
            if (totalNotesCount > 0)
            {
                avgNoteSize = (int)((totalContentSize / 1024.0) / totalNotesCount);
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error refreshing database stats");
        }
    }

    private async Task RefreshAllData()
    {
        await LoadDashboardData();
    }

    private string GetHealthBadgeClass()
    {
        return healthStatus switch
        {
            "Healthy" => "success",
            "Degraded" => "warning",
            "Error" => "danger",
            _ => "secondary"
        };
    }

    private string FormatUptime()
    {
        var uptime = DateTime.UtcNow - startupTime;
        if (uptime.TotalDays >= 1)
            return $"{(int)uptime.TotalDays}d {uptime.Hours}h";
        if (uptime.TotalHours >= 1)
            return $"{(int)uptime.TotalHours}h {uptime.Minutes}m";
        return $"{uptime.Minutes}m";
    }

    private long GetMemoryUsage()
    {
        return System.Diagnostics.Process.GetCurrentProcess().WorkingSet64 / (1024 * 1024);
    }

    private string FormatStorageSize(long bytes)
    {
        if (bytes < 1024)
            return $"{bytes} B";
        if (bytes < 1024 * 1024)
            return $"{bytes / 1024.0:F1} KB";
        if (bytes < 1024 * 1024 * 1024)
            return $"{bytes / (1024.0 * 1024):F1} MB";
        return $"{bytes / (1024.0 * 1024 * 1024):F2} GB";
    }

    private void ShowCommandInfo(string title, string command)
    {
        commandTitle = title;
        commandText = command;
        commandCopied = false;
        showCommandModal = true;
        StateHasChanged();
    }

    private void CloseCommandModal()
    {
        showCommandModal = false;
        StateHasChanged();
    }

    private async Task CopyCommand()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("copyToClipboardFallback", commandText);
            commandCopied = true;
            StateHasChanged();
            await Task.Delay(2000);
            commandCopied = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error copying to clipboard");
        }
    }
}